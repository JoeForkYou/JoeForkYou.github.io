<!DOCTYPE html><html lang="cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Zephyr 音频子系统指南 | JoeNero的博客</title><meta name="author" content="JoeNero"><meta name="copyright" content="JoeNero"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Zephyr 音频子系统指南版本信息 版本：V1.0 更新时间：2025年03月20日 23:45  1. 音频子系统概述Zephyr RTOS 提供了完整的音频子系统，支持音频捕获、处理和播放功能。音频子系统基于模块化架构，包括音频编解码器驱动、音频控制器、音频流管理和音频处理框架。 1.1 基础配置 (prj.conf)12345678910111213# 音频子系统支持CONFIG_AUDI">
<meta property="og:type" content="article">
<meta property="og:title" content="Zephyr 音频子系统指南">
<meta property="og:url" content="https://joeforkyou.github.io/2025/03/20/nodic/zephyr/audio/README/index.html">
<meta property="og:site_name" content="JoeNero的博客">
<meta property="og:description" content="Zephyr 音频子系统指南版本信息 版本：V1.0 更新时间：2025年03月20日 23:45  1. 音频子系统概述Zephyr RTOS 提供了完整的音频子系统，支持音频捕获、处理和播放功能。音频子系统基于模块化架构，包括音频编解码器驱动、音频控制器、音频流管理和音频处理框架。 1.1 基础配置 (prj.conf)12345678910111213# 音频子系统支持CONFIG_AUDI">
<meta property="og:locale">
<meta property="og:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg">
<meta property="article:published_time" content="2025-03-20T15:45:22.000Z">
<meta property="article:modified_time" content="2025-03-21T13:18:56.923Z">
<meta property="article:author" content="JoeNero">
<meta property="article:tag" content="zephyr">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg"><link rel="shortcut icon" href="/img/1.jpg"><link rel="canonical" href="https://joeforkyou.github.io/2025/03/20/nodic/zephyr/audio/README/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"IZ845G3SQG","apiKey":"381e98702820650923216a5f47f18d71","indexName":"movie","hitsPerPage":6,"languages":{"input_placeholder":"Search for Posts","hits_empty":"No results found for: ${query}","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Zephyr 音频子系统指南',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="JoeNero的博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">128</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">27</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">JoeNero的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Zephyr 音频子系统指南</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Zephyr 音频子系统指南</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-20T15:45:22.000Z" title="Created 2025-03-20 23:45:22">2025-03-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-21T13:18:56.923Z" title="Updated 2025-03-21 21:18:56">2025-03-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/zephyr/">zephyr</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Zephyr-音频子系统指南"><a href="#Zephyr-音频子系统指南" class="headerlink" title="Zephyr 音频子系统指南"></a>Zephyr 音频子系统指南</h1><h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><ul>
<li>版本：V1.0</li>
<li>更新时间：2025年03月20日 23:45</li>
</ul>
<h2 id="1-音频子系统概述"><a href="#1-音频子系统概述" class="headerlink" title="1. 音频子系统概述"></a>1. 音频子系统概述</h2><p>Zephyr RTOS 提供了完整的音频子系统，支持音频捕获、处理和播放功能。音频子系统基于模块化架构，包括音频编解码器驱动、音频控制器、音频流管理和音频处理框架。</p>
<h3 id="1-1-基础配置-prj-conf"><a href="#1-1-基础配置-prj-conf" class="headerlink" title="1.1 基础配置 (prj.conf)"></a>1.1 基础配置 (prj.conf)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 音频子系统支持</span><br><span class="line">CONFIG_AUDIO=y</span><br><span class="line">CONFIG_AUDIO_CODEC=y</span><br><span class="line">CONFIG_AUDIO_DMIC=y</span><br><span class="line">CONFIG_I2S=y</span><br><span class="line"></span><br><span class="line"># 音频处理支持</span><br><span class="line">CONFIG_AUDIO_PROCESSING=y</span><br><span class="line">CONFIG_AUDIO_SAMPLE_RATE_CONVERTER=y</span><br><span class="line"></span><br><span class="line"># 内存配置</span><br><span class="line">CONFIG_HEAP_MEM_POOL_SIZE=32768</span><br><span class="line">CONFIG_AUDIO_BUFFER_SIZE=4096</span><br></pre></td></tr></table></figure>

<h3 id="1-2-设备树配置"><a href="#1-2-设备树配置" class="headerlink" title="1.2 设备树配置"></a>1.2 设备树配置</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="title class_">aliases</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">dmic</span> <span class="operator">=</span> <span class="variable">&amp;dmic0</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">codec</span> <span class="operator">=</span> <span class="variable">&amp;codec0</span><span class="punctuation">;</span></span><br><span class="line">        i2s = <span class="variable">&amp;i2s0</span><span class="punctuation">;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">    dmic0:</span> <span class="title class_">dmic0</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;zephyr,dmic&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">clock-frequency</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3072000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">sample-rate</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">48000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">channels</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">    codec0:</span> <span class="title class_">codec0</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;zephyr,audio-codec&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">sample-rate</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">48000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">channels</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">    i2s0:</span> <span class="title class_">i2s0</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;zephyr,i2s&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">clock-frequency</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">12288000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">sample-rate</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">48000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">channels</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">2</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="attr">word-size</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">16</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-音频编解码器驱动"><a href="#2-音频编解码器驱动" class="headerlink" title="2. 音频编解码器驱动"></a>2. 音频编解码器驱动</h2><h3 id="2-1-编解码器初始化"><a href="#2-1-编解码器初始化" class="headerlink" title="2.1 编解码器初始化"></a>2.1 编解码器初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/audio/codec.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">codec_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">codec_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(codec0));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">audio_codec_cfg</span> <span class="title">codec_cfg</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!device_is_ready(codec_dev)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Codec device not ready\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置编解码器 */</span></span><br><span class="line">    codec_cfg.dai_type = AUDIO_DAI_TYPE_I2S;</span><br><span class="line">    codec_cfg.dai_cfg.i2s = &#123;</span><br><span class="line">        .word_size = <span class="number">16</span>,</span><br><span class="line">        .channels = <span class="number">2</span>,</span><br><span class="line">        .format = I2S_FMT_DATA_FORMAT_I2S,</span><br><span class="line">        .options = I2S_OPT_FRAME_CLK_MASTER | I2S_OPT_BIT_CLK_MASTER,</span><br><span class="line">        .frame_clk_freq = <span class="number">48000</span>,</span><br><span class="line">        .block_size = <span class="number">512</span>,</span><br><span class="line">        .timeout = <span class="number">1000</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化编解码器 */</span></span><br><span class="line">    ret = audio_codec_configure(codec_dev, &amp;codec_cfg);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to configure codec: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 启动编解码器 */</span></span><br><span class="line">    ret = audio_codec_start(codec_dev);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to start codec: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-编解码器控制"><a href="#2-2-编解码器控制" class="headerlink" title="2.2 编解码器控制"></a>2.2 编解码器控制</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/audio/codec.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">codec_control_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">codec_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(codec0));</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!device_is_ready(codec_dev)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置音量 */</span></span><br><span class="line">    ret = audio_codec_set_property(codec_dev,</span><br><span class="line">                                  AUDIO_PROPERTY_VOLUME,</span><br><span class="line">                                  AUDIO_CHANNEL_ALL,</span><br><span class="line">                                  <span class="number">80</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to set volume: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置静音 */</span></span><br><span class="line">    ret = audio_codec_set_property(codec_dev,</span><br><span class="line">                                  AUDIO_PROPERTY_MUTE,</span><br><span class="line">                                  AUDIO_CHANNEL_ALL,</span><br><span class="line">                                  <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to set mute: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置增益 */</span></span><br><span class="line">    ret = audio_codec_set_property(codec_dev,</span><br><span class="line">                                  AUDIO_PROPERTY_GAIN,</span><br><span class="line">                                  AUDIO_CHANNEL_LEFT,</span><br><span class="line">                                  <span class="number">6</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to set gain: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-音频数据流"><a href="#3-音频数据流" class="headerlink" title="3. 音频数据流"></a>3. 音频数据流</h2><h3 id="3-1-I2S-配置"><a href="#3-1-I2S-配置" class="headerlink" title="3.1 I2S 配置"></a>3.1 I2S 配置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/drivers/i2s.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_RATE   48000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_BIT_WIDTH 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHANNELS      2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE    512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_COUNT   4</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2s_config</span> <span class="title">i2s_cfg</span> =</span> &#123;</span><br><span class="line">    .word_size = SAMPLE_BIT_WIDTH,</span><br><span class="line">    .channels = CHANNELS,</span><br><span class="line">    .format = I2S_FMT_DATA_FORMAT_I2S,</span><br><span class="line">    .options = I2S_OPT_FRAME_CLK_MASTER | I2S_OPT_BIT_CLK_MASTER,</span><br><span class="line">    .frame_clk_freq = SAMPLE_RATE,</span><br><span class="line">    .block_size = BLOCK_SIZE,</span><br><span class="line">    .timeout = <span class="number">1000</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2s_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">i2s_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(i2s0));</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!device_is_ready(i2s_dev)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;I2S device not ready\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置 I2S */</span></span><br><span class="line">    ret = i2s_configure(i2s_dev, I2S_DIR_TX, &amp;i2s_cfg);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to configure I2S: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 触发 I2S 开始 */</span></span><br><span class="line">    ret = i2s_trigger(i2s_dev, I2S_DIR_TX, I2S_TRIGGER_START);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to start I2S: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-音频数据传输"><a href="#3-2-音频数据传输" class="headerlink" title="3.2 音频数据传输"></a>3.2 音频数据传输</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/drivers/i2s.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE    512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_RATE   48000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_BIT_WIDTH 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHANNELS      2</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int16_t</span> audio_buffer[BLOCK_SIZE / <span class="keyword">sizeof</span>(<span class="type">int16_t</span>)];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">audio_transfer_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">i2s_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(i2s0));</span><br><span class="line">    <span class="type">void</span> *tx_block;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 准备音频数据 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ARRAY_SIZE(audio_buffer); i++) &#123;</span><br><span class="line">        <span class="comment">/* 生成正弦波 */</span></span><br><span class="line">        audio_buffer[i] = (<span class="type">int16_t</span>)(<span class="number">32767.0f</span> *</span><br><span class="line">                                  sinf(<span class="number">2.0f</span> * <span class="number">3.14159f</span> * <span class="number">1000.0f</span> *</span><br><span class="line">                                       i / SAMPLE_RATE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取写入缓冲区 */</span></span><br><span class="line">    ret = i2s_buf_write(i2s_dev, audio_buffer, BLOCK_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to write to I2S buffer: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 读取音频数据 */</span></span><br><span class="line">    ret = i2s_buf_read(i2s_dev, &amp;tx_block, &amp;size);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to read from I2S buffer: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 处理读取的数据 */</span></span><br><span class="line">    process_audio_data(tx_block, size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 释放缓冲区 */</span></span><br><span class="line">    i2s_buf_release(i2s_dev, tx_block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-数字麦克风-DMIC"><a href="#4-数字麦克风-DMIC" class="headerlink" title="4. 数字麦克风 (DMIC)"></a>4. 数字麦克风 (DMIC)</h2><h3 id="4-1-DMIC-配置"><a href="#4-1-DMIC-配置" class="headerlink" title="4.1 DMIC 配置"></a>4.1 DMIC 配置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/audio/dmic.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_RATE     48000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHANNEL_COUNT   2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_BIT_WIDTH 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE      512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_COUNT     4</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">dmic_cfg</span> <span class="title">dmic_config</span> =</span> &#123;</span><br><span class="line">    .io = &#123;</span><br><span class="line">        .min_pdm_clk_freq = <span class="number">1024000</span>,</span><br><span class="line">        .max_pdm_clk_freq = <span class="number">4096000</span>,</span><br><span class="line">        .min_pdm_clk_dc = <span class="number">40</span>,</span><br><span class="line">        .max_pdm_clk_dc = <span class="number">60</span>,</span><br><span class="line">        .pdm_clk_pol = <span class="number">0</span>,</span><br><span class="line">        .pdm_data_pol = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .streams = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            .pcm_rate = SAMPLE_RATE,</span><br><span class="line">            .pcm_width = SAMPLE_BIT_WIDTH,</span><br><span class="line">            .block_size = BLOCK_SIZE,</span><br><span class="line">            .mem_slab = <span class="literal">NULL</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    .channel = &#123;</span><br><span class="line">        .req_num_chan = CHANNEL_COUNT,</span><br><span class="line">        .req_chan_map_lo = dmic_build_channel_map(<span class="number">0</span>, <span class="number">0</span>, PDM_CHAN_LEFT) |</span><br><span class="line">                         dmic_build_channel_map(<span class="number">1</span>, <span class="number">0</span>, PDM_CHAN_RIGHT),</span><br><span class="line">        .req_chan_map_hi = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dmic_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dmic_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(dmic0));</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!device_is_ready(dmic_dev)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;DMIC device not ready\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置 DMIC */</span></span><br><span class="line">    ret = dmic_configure(dmic_dev, &amp;dmic_config);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to configure DMIC: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 触发 DMIC 开始 */</span></span><br><span class="line">    ret = dmic_trigger(dmic_dev, DMIC_TRIGGER_START);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to start DMIC: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-DMIC-数据采集"><a href="#4-2-DMIC-数据采集" class="headerlink" title="4.2 DMIC 数据采集"></a>4.2 DMIC 数据采集</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/audio/dmic.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE      512</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">K_MEM_SLAB_DEFINE</span><span class="params">(mic_mem_slab, BLOCK_SIZE, <span class="number">4</span>, <span class="number">4</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">dmic_cfg</span> <span class="title">dmic_config</span> =</span> &#123;</span><br><span class="line">    <span class="comment">/* ... 配置同上 ... */</span></span><br><span class="line">    .streams = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            .pcm_rate = <span class="number">48000</span>,</span><br><span class="line">            .pcm_width = <span class="number">16</span>,</span><br><span class="line">            .block_size = BLOCK_SIZE,</span><br><span class="line">            .mem_slab = &amp;mic_mem_slab,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dmic_capture_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dmic_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(dmic0));</span><br><span class="line">    <span class="type">void</span> *buffer;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置 DMIC */</span></span><br><span class="line">    ret = dmic_configure(dmic_dev, &amp;dmic_config);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 触发 DMIC 开始 */</span></span><br><span class="line">    ret = dmic_trigger(dmic_dev, DMIC_TRIGGER_START);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 读取麦克风数据 */</span></span><br><span class="line">    ret = dmic_read(dmic_dev, <span class="number">0</span>, &amp;buffer, BLOCK_SIZE, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to read DMIC data: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 处理麦克风数据 */</span></span><br><span class="line">    process_mic_data(buffer, BLOCK_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 释放缓冲区 */</span></span><br><span class="line">    k_mem_slab_free(&amp;mic_mem_slab, buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 停止 DMIC */</span></span><br><span class="line">    dmic_trigger(dmic_dev, DMIC_TRIGGER_STOP);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-音频处理"><a href="#5-音频处理" class="headerlink" title="5. 音频处理"></a>5. 音频处理</h2><h3 id="5-1-音频格式转换"><a href="#5-1-音频格式转换" class="headerlink" title="5.1 音频格式转换"></a>5.1 音频格式转换</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/audio/dsp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 格式转换：16位有符号整数到32位浮点数 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">audio_format_conversion</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int16_t</span> input[<span class="number">256</span>];</span><br><span class="line">    <span class="type">float</span> output[<span class="number">256</span>];</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 准备输入数据 */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(input); i++) &#123;</span><br><span class="line">        input[i] = i * <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 转换格式 */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(input); i++) &#123;</span><br><span class="line">        output[i] = input[i] / <span class="number">32768.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 使用转换后的数据 */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(output); i++) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Sample %d: %f\n&quot;</span>, i, output[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-音频滤波器"><a href="#5-2-音频滤波器" class="headerlink" title="5.2 音频滤波器"></a>5.2 音频滤波器</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/audio/dsp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 简单的低通滤波器 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">audio_filter_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> input[<span class="number">256</span>];</span><br><span class="line">    <span class="type">float</span> output[<span class="number">256</span>];</span><br><span class="line">    <span class="type">float</span> coeff[<span class="number">5</span>] = &#123;<span class="number">0.1f</span>, <span class="number">0.2f</span>, <span class="number">0.4f</span>, <span class="number">0.2f</span>, <span class="number">0.1f</span>&#125;;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 准备输入数据 */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(input); i++) &#123;</span><br><span class="line">        input[i] = sinf(<span class="number">2.0f</span> * <span class="number">3.14159f</span> * <span class="number">1000.0f</span> * i / <span class="number">48000.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 应用滤波器 */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; ARRAY_SIZE(input) - <span class="number">2</span>; i++) &#123;</span><br><span class="line">        output[i] = <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; ARRAY_SIZE(coeff); j++) &#123;</span><br><span class="line">            output[i] += input[i + j - <span class="number">2</span>] * coeff[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 处理边界 */</span></span><br><span class="line">    output[<span class="number">0</span>] = input[<span class="number">0</span>] * coeff[<span class="number">2</span>];</span><br><span class="line">    output[<span class="number">1</span>] = input[<span class="number">0</span>] * coeff[<span class="number">1</span>] + input[<span class="number">1</span>] * coeff[<span class="number">2</span>] + input[<span class="number">2</span>] * coeff[<span class="number">3</span>];</span><br><span class="line">    output[ARRAY_SIZE(output) - <span class="number">2</span>] = input[ARRAY_SIZE(input) - <span class="number">4</span>] * coeff[<span class="number">0</span>] +</span><br><span class="line">                                    input[ARRAY_SIZE(input) - <span class="number">3</span>] * coeff[<span class="number">1</span>] +</span><br><span class="line">                                    input[ARRAY_SIZE(input) - <span class="number">2</span>] * coeff[<span class="number">2</span>];</span><br><span class="line">    output[ARRAY_SIZE(output) - <span class="number">1</span>] = input[ARRAY_SIZE(input) - <span class="number">3</span>] * coeff[<span class="number">0</span>] +</span><br><span class="line">                                    input[ARRAY_SIZE(input) - <span class="number">2</span>] * coeff[<span class="number">1</span>] +</span><br><span class="line">                                    input[ARRAY_SIZE(input) - <span class="number">1</span>] * coeff[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-音量控制"><a href="#5-3-音量控制" class="headerlink" title="5.3 音量控制"></a>5.3 音量控制</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 音量控制函数 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">audio_volume_control</span><span class="params">(<span class="type">int16_t</span> *buffer, <span class="type">size_t</span> size, <span class="type">int</span> volume_percent)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> gain = volume_percent / <span class="number">100.0f</span>;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 应用音量增益 */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size / <span class="keyword">sizeof</span>(<span class="type">int16_t</span>); i++) &#123;</span><br><span class="line">        <span class="type">float</span> sample = buffer[i];</span><br><span class="line">        sample *= gain;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 限幅 */</span></span><br><span class="line">        <span class="keyword">if</span> (sample &gt; <span class="number">32767.0f</span>) &#123;</span><br><span class="line">            sample = <span class="number">32767.0f</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sample &lt; <span class="number">-32768.0f</span>) &#123;</span><br><span class="line">            sample = <span class="number">-32768.0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buffer[i] = (<span class="type">int16_t</span>)sample;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-音频编解码"><a href="#6-音频编解码" class="headerlink" title="6. 音频编解码"></a>6. 音频编解码</h2><h3 id="6-1-PCM-编码"><a href="#6-1-PCM-编码" class="headerlink" title="6.1 PCM 编码"></a>6.1 PCM 编码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* PCM 编码参数 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pcm_params</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> sample_rate;</span><br><span class="line">    <span class="type">uint8_t</span> bit_depth;</span><br><span class="line">    <span class="type">uint8_t</span> channels;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* PCM 编码函数 */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pcm_encode</span><span class="params">(<span class="type">const</span> <span class="type">float</span> *samples, <span class="type">size_t</span> num_samples,</span></span><br><span class="line"><span class="params">              <span class="type">uint8_t</span> *pcm_data, <span class="type">size_t</span> pcm_size,</span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="keyword">struct</span> pcm_params *params)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> bytes_per_sample = params-&gt;bit_depth / <span class="number">8</span>;</span><br><span class="line">    <span class="type">size_t</span> required_size = num_samples * bytes_per_sample;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pcm_size &lt; required_size) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; num_samples; i++) &#123;</span><br><span class="line">        <span class="comment">/* 将浮点样本转换为整数 */</span></span><br><span class="line">        <span class="type">int32_t</span> sample_int;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (params-&gt;bit_depth == <span class="number">16</span>) &#123;</span><br><span class="line">            sample_int = (<span class="type">int32_t</span>)(samples[i] * <span class="number">32767.0f</span>);</span><br><span class="line">            <span class="keyword">if</span> (sample_int &gt; <span class="number">32767</span>) sample_int = <span class="number">32767</span>;</span><br><span class="line">            <span class="keyword">if</span> (sample_int &lt; <span class="number">-32768</span>) sample_int = <span class="number">-32768</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* 写入 16 位 PCM 数据 */</span></span><br><span class="line">            pcm_data[i * <span class="number">2</span>] = sample_int &amp; <span class="number">0xFF</span>;</span><br><span class="line">            pcm_data[i * <span class="number">2</span> + <span class="number">1</span>] = (sample_int &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params-&gt;bit_depth == <span class="number">24</span>) &#123;</span><br><span class="line">            sample_int = (<span class="type">int32_t</span>)(samples[i] * <span class="number">8388607.0f</span>);</span><br><span class="line">            <span class="keyword">if</span> (sample_int &gt; <span class="number">8388607</span>) sample_int = <span class="number">8388607</span>;</span><br><span class="line">            <span class="keyword">if</span> (sample_int &lt; <span class="number">-8388608</span>) sample_int = <span class="number">-8388608</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* 写入 24 位 PCM 数据 */</span></span><br><span class="line">            pcm_data[i * <span class="number">3</span>] = sample_int &amp; <span class="number">0xFF</span>;</span><br><span class="line">            pcm_data[i * <span class="number">3</span> + <span class="number">1</span>] = (sample_int &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">            pcm_data[i * <span class="number">3</span> + <span class="number">2</span>] = (sample_int &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> required_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-WAV-文件格式"><a href="#6-2-WAV-文件格式" class="headerlink" title="6.2 WAV 文件格式"></a>6.2 WAV 文件格式</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/fs/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* WAV 文件头 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wav_header</span> &#123;</span></span><br><span class="line">    <span class="comment">/* RIFF 块 */</span></span><br><span class="line">    <span class="type">uint8_t</span> riff_header[<span class="number">4</span>];    <span class="comment">/* &quot;RIFF&quot; */</span></span><br><span class="line">    <span class="type">uint32_t</span> wav_size;         <span class="comment">/* 文件大小 - 8 */</span></span><br><span class="line">    <span class="type">uint8_t</span> wave_header[<span class="number">4</span>];    <span class="comment">/* &quot;WAVE&quot; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* fmt 块 */</span></span><br><span class="line">    <span class="type">uint8_t</span> fmt_header[<span class="number">4</span>];     <span class="comment">/* &quot;fmt &quot; */</span></span><br><span class="line">    <span class="type">uint32_t</span> fmt_chunk_size;   <span class="comment">/* 16 for PCM */</span></span><br><span class="line">    <span class="type">uint16_t</span> audio_format;     <span class="comment">/* 1 for PCM */</span></span><br><span class="line">    <span class="type">uint16_t</span> num_channels;</span><br><span class="line">    <span class="type">uint32_t</span> sample_rate;</span><br><span class="line">    <span class="type">uint32_t</span> byte_rate;</span><br><span class="line">    <span class="type">uint16_t</span> block_align;</span><br><span class="line">    <span class="type">uint16_t</span> bits_per_sample;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* data 块 */</span></span><br><span class="line">    <span class="type">uint8_t</span> data_header[<span class="number">4</span>];    <span class="comment">/* &quot;data&quot; */</span></span><br><span class="line">    <span class="type">uint32_t</span> data_bytes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 创建 WAV 文件 */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_wav_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">uint8_t</span> *audio_data,</span></span><br><span class="line"><span class="params">                   <span class="type">size_t</span> data_size, <span class="type">uint32_t</span> sample_rate,</span></span><br><span class="line"><span class="params">                   <span class="type">uint16_t</span> channels, <span class="type">uint16_t</span> bit_depth)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fs_file_t</span> <span class="title">file</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wav_header</span> <span class="title">header</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化文件对象 */</span></span><br><span class="line">    fs_file_t_init(&amp;file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 创建文件 */</span></span><br><span class="line">    ret = fs_open(&amp;file, filename, FS_O_CREATE | FS_O_WRITE);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 填充 WAV 头 */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(header.riff_header, <span class="string">&quot;RIFF&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    header.wav_size = data_size + <span class="keyword">sizeof</span>(header) - <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(header.wave_header, <span class="string">&quot;WAVE&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(header.fmt_header, <span class="string">&quot;fmt &quot;</span>, <span class="number">4</span>);</span><br><span class="line">    header.fmt_chunk_size = <span class="number">16</span>;</span><br><span class="line">    header.audio_format = <span class="number">1</span>; <span class="comment">/* PCM */</span></span><br><span class="line">    header.num_channels = channels;</span><br><span class="line">    header.sample_rate = sample_rate;</span><br><span class="line">    header.byte_rate = sample_rate * channels * (bit_depth / <span class="number">8</span>);</span><br><span class="line">    header.block_align = channels * (bit_depth / <span class="number">8</span>);</span><br><span class="line">    header.bits_per_sample = bit_depth;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(header.data_header, <span class="string">&quot;data&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    header.data_bytes = data_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 写入 WAV 头 */</span></span><br><span class="line">    ret = fs_write(&amp;file, &amp;header, <span class="keyword">sizeof</span>(header));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        fs_close(&amp;file);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 写入音频数据 */</span></span><br><span class="line">    ret = fs_write(&amp;file, audio_data, data_size);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        fs_close(&amp;file);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 关闭文件 */</span></span><br><span class="line">    fs_close(&amp;file);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-音频应用示例"><a href="#7-音频应用示例" class="headerlink" title="7. 音频应用示例"></a>7. 音频应用示例</h2><h3 id="7-1-音频录制与播放"><a href="#7-1-音频录制与播放" class="headerlink" title="7.1 音频录制与播放"></a>7.1 音频录制与播放</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/audio/dmic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/drivers/i2s.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_RATE     48000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_BIT_WIDTH 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHANNELS        2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE      512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_COUNT     4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 内存分配 */</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">K_MEM_SLAB_DEFINE</span><span class="params">(mic_mem_slab, BLOCK_SIZE, BLOCK_COUNT, <span class="number">4</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="title function_">K_MEM_SLAB_DEFINE</span><span class="params">(i2s_mem_slab, BLOCK_SIZE, BLOCK_COUNT, <span class="number">4</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DMIC 配置 */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">dmic_cfg</span> <span class="title">dmic_config</span> =</span> &#123;</span><br><span class="line">    <span class="comment">/* ... 配置同上 ... */</span></span><br><span class="line">    .streams = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            .pcm_rate = SAMPLE_RATE,</span><br><span class="line">            .pcm_width = SAMPLE_BIT_WIDTH,</span><br><span class="line">            .block_size = BLOCK_SIZE,</span><br><span class="line">            .mem_slab = &amp;mic_mem_slab,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2S 配置 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2s_config</span> <span class="title">i2s_cfg</span> =</span> &#123;</span><br><span class="line">    .word_size = SAMPLE_BIT_WIDTH,</span><br><span class="line">    .channels = CHANNELS,</span><br><span class="line">    .format = I2S_FMT_DATA_FORMAT_I2S,</span><br><span class="line">    .options = I2S_OPT_FRAME_CLK_MASTER | I2S_OPT_BIT_CLK_MASTER,</span><br><span class="line">    .frame_clk_freq = SAMPLE_RATE,</span><br><span class="line">    .block_size = BLOCK_SIZE,</span><br><span class="line">    .timeout = <span class="number">1000</span>,</span><br><span class="line">    .mem_slab = &amp;i2s_mem_slab,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">audio_record_playback</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dmic_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(dmic0));</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">i2s_dev</span> =</span> DEVICE_DT_GET(DT_NODELABEL(i2s0));</span><br><span class="line">    <span class="type">void</span> *buffer;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置 DMIC */</span></span><br><span class="line">    ret = dmic_configure(dmic_dev, &amp;dmic_config);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置 I2S */</span></span><br><span class="line">    ret = i2s_configure(i2s_dev, I2S_DIR_TX, &amp;i2s_cfg);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 启动 DMIC 和 I2S */</span></span><br><span class="line">    dmic_trigger(dmic_dev, DMIC_TRIGGER_START);</span><br><span class="line">    i2s_trigger(i2s_dev, I2S_DIR_TX, I2S_TRIGGER_START);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* 读取麦克风数据 */</span></span><br><span class="line">        ret = dmic_read(dmic_dev, <span class="number">0</span>, &amp;buffer, BLOCK_SIZE, <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 处理音频数据 */</span></span><br><span class="line">        process_audio_data(buffer, BLOCK_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 写入 I2S 播放 */</span></span><br><span class="line">        ret = i2s_write(i2s_dev, buffer, BLOCK_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            k_mem_slab_free(&amp;mic_mem_slab, buffer);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 释放缓冲区 */</span></span><br><span class="line">        k_mem_slab_free(&amp;mic_mem_slab, buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-音频效果处理"><a href="#7-2-音频效果处理" class="headerlink" title="7.2 音频效果处理"></a>7.2 音频效果处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 回声效果参数 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">echo_params</span> &#123;</span></span><br><span class="line">    <span class="type">int16_t</span> *delay_buffer;</span><br><span class="line">    <span class="type">size_t</span> buffer_size;</span><br><span class="line">    <span class="type">size_t</span> delay_samples;</span><br><span class="line">    <span class="type">float</span> decay;</span><br><span class="line">    <span class="type">size_t</span> write_index;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 初始化回声效果 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">echo_init</span><span class="params">(<span class="keyword">struct</span> echo_params *echo, <span class="type">size_t</span> delay_ms, <span class="type">float</span> decay,</span></span><br><span class="line"><span class="params">              <span class="type">uint32_t</span> sample_rate)</span></span><br><span class="line">&#123;</span><br><span class="line">    echo-&gt;delay_samples = (delay_ms * sample_rate) / <span class="number">1000</span>;</span><br><span class="line">    echo-&gt;buffer_size = echo-&gt;delay_samples * <span class="keyword">sizeof</span>(<span class="type">int16_t</span>);</span><br><span class="line">    echo-&gt;delay_buffer = k_malloc(echo-&gt;buffer_size);</span><br><span class="line">    echo-&gt;decay = decay;</span><br><span class="line">    echo-&gt;write_index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (echo-&gt;delay_buffer) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(echo-&gt;delay_buffer, <span class="number">0</span>, echo-&gt;buffer_size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 应用回声效果 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">apply_echo_effect</span><span class="params">(<span class="keyword">struct</span> echo_params *echo, <span class="type">int16_t</span> *buffer,</span></span><br><span class="line"><span class="params">                      <span class="type">size_t</span> num_samples)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    <span class="type">size_t</span> read_index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!echo-&gt;delay_buffer) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_samples; i++) &#123;</span><br><span class="line">        <span class="comment">/* 计算读取索引 */</span></span><br><span class="line">        read_index = (echo-&gt;write_index + i) % echo-&gt;delay_samples;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 添加回声 */</span></span><br><span class="line">        <span class="type">int32_t</span> sample = buffer[i];</span><br><span class="line">        sample += (<span class="type">int32_t</span>)(echo-&gt;delay_buffer[read_index] * echo-&gt;decay);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 限幅 */</span></span><br><span class="line">        <span class="keyword">if</span> (sample &gt; <span class="number">32767</span>) &#123;</span><br><span class="line">            sample = <span class="number">32767</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sample &lt; <span class="number">-32768</span>) &#123;</span><br><span class="line">            sample = <span class="number">-32768</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 更新缓冲区 */</span></span><br><span class="line">        echo-&gt;delay_buffer[read_index] = buffer[i];</span><br><span class="line">        buffer[i] = (<span class="type">int16_t</span>)sample;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 更新写入索引 */</span></span><br><span class="line">    echo-&gt;write_index = (echo-&gt;write_index + num_samples) % echo-&gt;delay_samples;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-音频子系统最佳实践"><a href="#8-音频子系统最佳实践" class="headerlink" title="8. 音频子系统最佳实践"></a>8. 音频子系统最佳实践</h2><ol>
<li><p>缓冲区管理：</p>
<ul>
<li>使用适当大小的缓冲区以平衡延迟和处理开销</li>
<li>实现双缓冲或环形缓冲区以避免数据丢失</li>
<li>考虑使用 DMA 进行高效数据传输</li>
</ul>
</li>
<li><p>采样率和位深度：</p>
<ul>
<li>根据应用需求选择合适的采样率和位深度</li>
<li>考虑功耗和性能之间的权衡</li>
<li>实现采样率转换以支持不同设备</li>
</ul>
</li>
<li><p>音频处理：</p>
<ul>
<li>在定点数学运算中使用适当的缩放以避免溢出</li>
<li>考虑使用 DSP 加速指令进行处理</li>
<li>实现高效的滤波器算法</li>
</ul>
</li>
<li><p>同步处理：</p>
<ul>
<li>确保音频捕获和播放之间的同步</li>
<li>实现缓冲区调整以处理时钟偏差</li>
<li>考虑使用硬件同步机制</li>
</ul>
</li>
<li><p>电源管理：</p>
<ul>
<li>在不使用时禁用音频设备</li>
<li>实现动态时钟调整以节省功耗</li>
<li>考虑使用低功耗模式</li>
</ul>
</li>
<li><p>错误处理：</p>
<ul>
<li>实现完善的错误检测和恢复机制</li>
<li>处理缓冲区溢出和欠载情况</li>
<li>提供诊断信息</li>
</ul>
</li>
<li><p>测试与验证：</p>
<ul>
<li>进行音频质量测试</li>
<li>测量延迟和抖动</li>
<li>验证在不同条件下的性能</li>
</ul>
</li>
<li><p>可扩展性：</p>
<ul>
<li>设计模块化的音频处理管道</li>
<li>支持动态加载和卸载音频处理模块</li>
<li>考虑未来的功能扩展</li>
</ul>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io">JoeNero</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io/2025/03/20/nodic/zephyr/audio/README/">https://joeforkyou.github.io/2025/03/20/nodic/zephyr/audio/README/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/zephyr/">zephyr</a></div><div class="post-share"><div class="social-share" data-image="/img/%E7%BE%8E%E5%A5%B3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/21/nodic/zephyr/bluetooth/README/" title="Zephyr 蓝牙协议栈指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Zephyr 蓝牙协议栈指南</div></div><div class="info-2"><div class="info-item-1">    .mermaid .label{font-family:trebuchet ms,verdana,arial;color:#333}.node circle,.node ellipse,.node polygon,.node rect{fill:#cde498;stroke:#13540c;stroke-width:1px}.node.clickable{cursor:pointer}.arrowheadPath{fill:green}.edgePath .path{stroke:green;stroke-width:1.5px}.edgeLabel{background-color:#e8e8e8}.cluster rect{fill:#cdffb2!important;rx:4!important;stroke:#6eaa49!important;stroke-width:1px!important}.cluster...</div></div></div></a><a class="pagination-related" href="/2025/03/20/nodic/zephyr/architecture/drivers/" title="Zephyr 驱动模型"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Zephyr 驱动模型</div></div><div class="info-2"><div class="info-item-1">Zephyr 驱动模型版本信息 版本：V1.0 更新时间：2025年03月20日 23:30  Zephyr RTOS 提供了一个统一的驱动模型，用于管理和操作各种硬件设备。这个模型定义了驱动程序的结构、初始化过程和操作方法，使得驱动开发更加标准化和模块化。 驱动模型概述驱动模型的目标 抽象硬件差异：提供统一的 API，隐藏底层硬件细节 简化驱动开发：标准化驱动程序的结构和接口 提高可移植性：使应用程序可以在不同硬件平台上运行 支持动态配置：通过设备树实现驱动的动态配置  核心概念 设备对象：表示一个硬件设备的软件抽象 驱动 API：定义了设备操作的标准接口 设备树：描述硬件配置和设备关系 设备模型：管理设备生命周期和依赖关系  驱动程序结构设备结构体123456struct device &#123;    const char *name;    const void *config;    const void *api;    void *data;&#125;;   name: 设备名称 config: 设备配置信息（只读） api: 设备操作函数指针 data:...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/03/20/zephyer/zephyer1/" title="【Zephyr】【一】Zephyr RTOS 示例代码集"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-20</div><div class="info-item-2">【Zephyr】【一】Zephyr RTOS 示例代码集</div></div><div class="info-2"><div class="info-item-1">Zephyr RTOS 示例代码集1. 基础示例1.0 基础配置每个示例都需要一个 prj.conf 文件来配置项目。以下是各个示例所需的配置： 基础示例 prj.conf1234567891011# 控制台输出CONFIG_PRINTK=yCONFIG_SERIAL=yCONFIG_UART_CONSOLE=y# 日志系统CONFIG_LOG=yCONFIG_LOG_DEFAULT_LEVEL=3# 内核配置CONFIG_KERNEL_BIN_NAME=&quot;app&quot;  线程示例 prj.conf123456789# 基础配置CONFIG_PRINTK=yCONFIG_SERIAL=yCONFIG_UART_CONSOLE=y# 线程配置CONFIG_THREAD_NAME=yCONFIG_THREAD_MONITOR=yCONFIG_THREAD_STACK_INFO=y  1.1 Hello...</div></div></div></a><a class="pagination-related" href="/2025/03/20/zephyer/zephyr2/" title="【Zephyr】【二】Zephyr RTOS 系统架构"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-20</div><div class="info-item-2">【Zephyr】【二】Zephyr RTOS 系统架构</div></div><div class="info-2"><div class="info-item-1"> mermaid.initialize({startOnLoad:true});  Zephyr RTOS 系统架构整体架构 graph TB     subgraph "应用层"         App1[应用1]         App2[应用2]         App3[应用3]     end     subgraph "系统服务层"         FS[文件系统]         Net[网络协议栈]         Shell[命令行界面]     end     subgraph "内核层"         Sched[调度器]         Mem[内存管理]         IPC[进程间通信]         Time[时间管理]     end     subgraph "硬件抽象层"         GPIO[GPIO驱动]         UART[串口驱动]         SPI[SPI驱动]         I2C[I2C驱动]     end     App1 & App2 & App3 --> FS & Net & Shell    ...</div></div></div></a><a class="pagination-related" href="/2023/12/21/nodic/zephyr/README/" title="Zephyr RTOS 学习指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-21</div><div class="info-item-2">Zephyr RTOS 学习指南</div></div><div class="info-2"><div class="info-item-1">Zephyr RTOS 学习指南版本信息 版本：V1.0 更新时间：2025年03月20日 22:09  目录结构 快速入门  环境搭建 Hello World 示例 基本概念   系统架构  内核架构 硬件支持 设备树 驱动模型   核心模块  内核模块 线程管理 内存管理 中断处理 定时器   驱动系统 GPIO UART SPI I2C   网络协议栈 文件系统 电源管理   开发指南  应用开发流程 驱动开发指南 调试技巧 测试框架 贡献指南   示例代码  基础示例 网络示例 传感器示例 蓝牙示例   硬件支持  支持的开发板 添加新板子 硬件抽象层   工具链  构建系统 IDE支持 调试工具 安装指南   常见问题  编译问题 运行问题 开发问题    文档说明本文档旨在帮助开发者快速上手 Zephyr RTOS，涵盖了从入门到进阶的完整学习路径。基于 Zephyr v2.9.1...</div></div></div></a><a class="pagination-related" href="/2025/03/20/nodic/zephyr/architecture/README/" title="Zephyr RTOS 系统架构"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-20</div><div class="info-item-2">Zephyr RTOS 系统架构</div></div><div class="info-2"><div class="info-item-1">Zephyr RTOS 系统架构版本信息 版本：V1.0 更新时间：2025年03月20日 22:30  Zephyr RTOS 是一个模块化、可扩展的实时操作系统，设计用于资源受限的嵌入式系统。本章节将介绍 Zephyr 的整体系统架构。 目录 内核架构 硬件支持 设备树 驱动模型  架构概览Zephyr 的系统架构主要包括以下几个部分：  微内核  提供基本的线程管理、同步原语和内存管理 支持抢占式多任务和协作式多任务 实现了实时调度器   硬件抽象层 (HAL)  提供统一的硬件访问接口 支持多种 CPU 架构和开发板   设备驱动框架  统一的驱动模型 支持动态加载和卸载驱动   网络协议栈  支持多种网络协议，如 TCP&#x2F;IP、Bluetooth、IEEE 802.15.4   文件系统  支持多种文件系统，如 FAT、LittleFS   电源管理  提供低功耗模式和动态频率调节   安全子系统  提供加密、认证和安全启动等功能    模块化设计Zephyr 采用高度模块化的设计，主要体现在：  内核模块化  核心功能和可选功能分离 通过 Kconfig...</div></div></div></a><a class="pagination-related" href="/2023/12/21/nodic/zephyr/architecture/devicetree/" title="Zephyr 设备树"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-21</div><div class="info-item-2">Zephyr 设备树</div></div><div class="info-2"><div class="info-item-1">Zephyr 设备树版本信息 版本：V1.0 更新时间：2025年03月20日 23:15  设备树（Device Tree）是 Zephyr RTOS 用于描述硬件配置的机制。它提供了一种统一的方式来描述系统硬件，使得硬件配置与软件代码分离，提高了代码的可移植性和可维护性。 设备树概述什么是设备树设备树是一种描述硬件的数据结构，它以树形结构表示硬件设备及其属性。在 Zephyr 中，设备树用于：  描述硬件配置 生成设备驱动的初始化代码 配置中断和引脚复用 定义内存映射  设备树的优势 硬件描述与软件分离：便于硬件配置的修改和维护 跨平台兼容性：同一套代码可以适用于不同的硬件平台 动态配置：支持运行时修改设备配置 标准化：采用行业标准的描述方式，提高可读性和互操作性  设备树语法基本结构设备树文件（.dts）的基本结构如下： 123456789101112131415161718/dts-v1/;/ &#123;    model = &quot;Example Board&quot;;    compatible = &quot;example,board&quot;;  ...</div></div></div></a><a class="pagination-related" href="/2025/03/20/nodic/zephyr/architecture/kernel/" title="Zephyr 内核架构"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-20</div><div class="info-item-2">Zephyr 内核架构</div></div><div class="info-2"><div class="info-item-1">Zephyr 内核架构版本信息 版本：V1.0 更新时间：2025年03月20日 22:45  Zephyr 内核是一个实时操作系统内核，专为资源受限的嵌入式系统设计。本文档将详细介绍 Zephyr 内核的架构设计和核心组件。 内核概述Zephyr 内核是一个单体内核（Monolithic Kernel），具有以下特点：  实时性：支持抢占式调度，保证任务的实时响应 可扩展性：模块化设计，可根据应用需求裁剪 低资源占用：最小配置下内存占用仅几 KB 多架构支持：支持多种 CPU 架构 可配置性：通过 Kconfig 系统高度可配置  内核组件线程管理Zephyr 内核提供了完整的线程管理功能：  线程创建与销毁 12k_thread_create(thread, stack, stack_size, entry, p1, p2, p3, prio, options, delay);k_thread_abort(thread);  线程优先级  支持 0-15...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">JoeNero</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">128</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">27</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/JoeForkYou"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/JoeForkYou" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:17549663745@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">wow!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zephyr-%E9%9F%B3%E9%A2%91%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">Zephyr 音频子系统指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.</span> <span class="toc-text">版本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%9F%B3%E9%A2%91%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">1. 音频子系统概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE-prj-conf"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 基础配置 (prj.conf)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E5%A4%87%E6%A0%91%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 设备树配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%9F%B3%E9%A2%91%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.3.</span> <span class="toc-text">2. 音频编解码器驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 编解码器初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E6%8E%A7%E5%88%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 编解码器控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%9F%B3%E9%A2%91%E6%95%B0%E6%8D%AE%E6%B5%81"><span class="toc-number">1.4.</span> <span class="toc-text">3. 音频数据流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-I2S-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 I2S 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E9%9F%B3%E9%A2%91%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 音频数据传输</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%95%B0%E5%AD%97%E9%BA%A6%E5%85%8B%E9%A3%8E-DMIC"><span class="toc-number">1.5.</span> <span class="toc-text">4. 数字麦克风 (DMIC)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-DMIC-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 DMIC 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-DMIC-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 DMIC 数据采集</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%9F%B3%E9%A2%91%E5%A4%84%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">5. 音频处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E9%9F%B3%E9%A2%91%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 音频格式转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E9%9F%B3%E9%A2%91%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 音频滤波器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E9%9F%B3%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">1.6.3.</span> <span class="toc-text">5.3 音量控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%9F%B3%E9%A2%91%E7%BC%96%E8%A7%A3%E7%A0%81"><span class="toc-number">1.7.</span> <span class="toc-text">6. 音频编解码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-PCM-%E7%BC%96%E7%A0%81"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1 PCM 编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-WAV-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 WAV 文件格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%9F%B3%E9%A2%91%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.8.</span> <span class="toc-text">7. 音频应用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E9%9F%B3%E9%A2%91%E5%BD%95%E5%88%B6%E4%B8%8E%E6%92%AD%E6%94%BE"><span class="toc-number">1.8.1.</span> <span class="toc-text">7.1 音频录制与播放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E9%9F%B3%E9%A2%91%E6%95%88%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">1.8.2.</span> <span class="toc-text">7.2 音频效果处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%9F%B3%E9%A2%91%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.9.</span> <span class="toc-text">8. 音频子系统最佳实践</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/05/C/C/" title="C 语言高级编程指南：回调函数与设计模式">C 语言高级编程指南：回调函数与设计模式</a><time datetime="2025-04-05T06:13:08.000Z" title="Created 2025-04-05 14:13:08">2025-04-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/04/CPP/CPP%E5%9F%BA%E7%A1%80_5_%E9%80%9F%E9%80%9A/" title="【CPP基础】【五】【CPP速通】">【CPP基础】【五】【CPP速通】</a><time datetime="2025-04-04T08:51:04.000Z" title="Created 2025-04-04 16:51:04">2025-04-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/drivers/" title="drivers">drivers</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/filesystem/" title="filesystem">filesystem</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/hardware/" title="hardware">hardware</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By JoeNero</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>