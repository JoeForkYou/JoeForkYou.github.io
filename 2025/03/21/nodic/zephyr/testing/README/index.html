<!DOCTYPE html><html lang="cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>README | JoeNero的博客</title><meta name="author" content="JoeNero"><meta name="copyright" content="JoeNero"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Zephyr 系统测试指南1. 测试框架概述1.1 测试架构1234567891011graph TD    A[测试用例] --&gt; B[测试框架]    B --&gt; C[测试运行器]    C --&gt; D[测试报告]        subgraph &quot;测试类型&quot;        E[单元测试]        F[集成测试]        G[系统测试]">
<meta property="og:type" content="article">
<meta property="og:title" content="README">
<meta property="og:url" content="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/testing/README/index.html">
<meta property="og:site_name" content="JoeNero的博客">
<meta property="og:description" content="Zephyr 系统测试指南1. 测试框架概述1.1 测试架构1234567891011graph TD    A[测试用例] --&gt; B[测试框架]    B --&gt; C[测试运行器]    C --&gt; D[测试报告]        subgraph &quot;测试类型&quot;        E[单元测试]        F[集成测试]        G[系统测试]">
<meta property="og:locale">
<meta property="og:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg">
<meta property="article:published_time" content="2025-03-21T12:49:56.000Z">
<meta property="article:modified_time" content="2025-03-21T13:20:53.524Z">
<meta property="article:author" content="JoeNero">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg"><link rel="shortcut icon" href="/img/1.jpg"><link rel="canonical" href="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/testing/README/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"IZ845G3SQG","apiKey":"381e98702820650923216a5f47f18d71","indexName":"movie","hitsPerPage":6,"languages":{"input_placeholder":"Search for Posts","hits_empty":"No results found for: ${query}","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'README',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="JoeNero的博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">126</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">JoeNero的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">README</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">README</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-21T13:20:53.524Z" title="Updated 2025-03-21 21:20:53">2025-03-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Zephyr-系统测试指南"><a href="#Zephyr-系统测试指南" class="headerlink" title="Zephyr 系统测试指南"></a>Zephyr 系统测试指南</h1><h2 id="1-测试框架概述"><a href="#1-测试框架概述" class="headerlink" title="1. 测试框架概述"></a>1. 测试框架概述</h2><h3 id="1-1-测试架构"><a href="#1-1-测试架构" class="headerlink" title="1.1 测试架构"></a>1.1 测试架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[测试用例] --&gt; B[测试框架]</span><br><span class="line">    B --&gt; C[测试运行器]</span><br><span class="line">    C --&gt; D[测试报告]</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;测试类型&quot;</span><br><span class="line">        E[单元测试]</span><br><span class="line">        F[集成测试]</span><br><span class="line">        G[系统测试]</span><br><span class="line">        H[性能测试]</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h3 id="1-2-测试配置"><a href="#1-2-测试配置" class="headerlink" title="1.2 测试配置"></a>1.2 测试配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 测试支持</span><br><span class="line">CONFIG_ZTEST=y</span><br><span class="line">CONFIG_ZTEST_NEW_API=y</span><br><span class="line"></span><br><span class="line"># 断言支持</span><br><span class="line">CONFIG_ASSERT=y</span><br><span class="line"></span><br><span class="line"># 覆盖率支持</span><br><span class="line">CONFIG_COVERAGE=y</span><br><span class="line">CONFIG_COVERAGE_GCOV=y</span><br></pre></td></tr></table></figure>

<h2 id="2-单元测试"><a href="#2-单元测试" class="headerlink" title="2. 单元测试"></a>2. 单元测试</h2><h3 id="2-1-基本测试用例"><a href="#2-1-基本测试用例" class="headerlink" title="2.1 基本测试用例"></a>2.1 基本测试用例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试套件 */</span></span><br><span class="line">ZTEST_SUITE(basic_tests, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试用例 */</span></span><br><span class="line">ZTEST(basic_tests, test_assert)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    zassert_true(a &lt; b, <span class="string">&quot;a should be less than b&quot;</span>);</span><br><span class="line">    zassert_equal(a + <span class="number">1</span>, b, <span class="string">&quot;a + 1 should equal b&quot;</span>);</span><br><span class="line">    zassert_not_null(&amp;a, <span class="string">&quot;a should not be null&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试功能 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">add_numbers</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZTEST(basic_tests, test_add)</span><br><span class="line">&#123;</span><br><span class="line">    zassert_equal(add_numbers(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>,</span><br><span class="line">                 <span class="string">&quot;2 + 3 should equal 5&quot;</span>);</span><br><span class="line">    zassert_equal(add_numbers(<span class="number">-1</span>, <span class="number">1</span>), <span class="number">0</span>,</span><br><span class="line">                 <span class="string">&quot;-1 + 1 should equal 0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-测试夹具"><a href="#2-2-测试夹具" class="headerlink" title="2.2 测试夹具"></a>2.2 测试夹具</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试夹具结构 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">test_fixture</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> test_value;</span><br><span class="line">    <span class="type">void</span> *resource;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 夹具设置 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">setup_fixture</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">test_fixture</span> *<span class="title">fixture</span>;</span></span><br><span class="line">    </span><br><span class="line">    fixture = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> test_fixture));</span><br><span class="line">    fixture-&gt;test_value = <span class="number">42</span>;</span><br><span class="line">    fixture-&gt;resource = <span class="built_in">malloc</span>(<span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> fixture;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 夹具清理 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">teardown_fixture</span><span class="params">(<span class="type">void</span> *f)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">test_fixture</span> *<span class="title">fixture</span> =</span> f;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(fixture-&gt;resource);</span><br><span class="line">    <span class="built_in">free</span>(fixture);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用夹具的测试套件 */</span></span><br><span class="line">ZTEST_SUITE(fixture_tests, <span class="literal">NULL</span>, setup_fixture,</span><br><span class="line">            <span class="literal">NULL</span>, <span class="literal">NULL</span>, teardown_fixture);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试用例 */</span></span><br><span class="line">ZTEST_F(fixture_tests, test_fixture)</span><br><span class="line">&#123;</span><br><span class="line">    zassert_equal(fixture-&gt;test_value, <span class="number">42</span>,</span><br><span class="line">                 <span class="string">&quot;Fixture value should be 42&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-集成测试"><a href="#3-集成测试" class="headerlink" title="3. 集成测试"></a>3. 集成测试</h2><h3 id="3-1-设备驱动测试"><a href="#3-1-设备驱动测试" class="headerlink" title="3.1 设备驱动测试"></a>3.1 设备驱动测试</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/drivers/gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* GPIO驱动测试 */</span></span><br><span class="line">ZTEST(gpio_tests, test_gpio_config)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    dev = device_get_binding(<span class="string">&quot;GPIO_0&quot;</span>);</span><br><span class="line">    zassert_not_null(dev, <span class="string">&quot;GPIO device not found&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = gpio_pin_configure(dev, <span class="number">10</span>, GPIO_OUTPUT);</span><br><span class="line">    zassert_equal(ret, <span class="number">0</span>, <span class="string">&quot;GPIO config failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2C驱动测试 */</span></span><br><span class="line">ZTEST(i2c_tests, test_i2c_transfer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="type">uint8_t</span> data[<span class="number">2</span>] = &#123;<span class="number">0x01</span>, <span class="number">0x02</span>&#125;;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    dev = device_get_binding(<span class="string">&quot;I2C_0&quot;</span>);</span><br><span class="line">    zassert_not_null(dev, <span class="string">&quot;I2C device not found&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = i2c_write(dev, data, <span class="keyword">sizeof</span>(data), <span class="number">0x50</span>);</span><br><span class="line">    zassert_equal(ret, <span class="number">0</span>, <span class="string">&quot;I2C write failed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-协议栈测试"><a href="#3-2-协议栈测试" class="headerlink" title="3.2 协议栈测试"></a>3.2 协议栈测试</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/net/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 网络协议测试 */</span></span><br><span class="line">ZTEST(network_tests, test_socket_creation)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> sock;</span><br><span class="line">    </span><br><span class="line">    sock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    zassert_true(sock &gt;= <span class="number">0</span>, <span class="string">&quot;Socket creation failed&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 蓝牙协议测试 */</span></span><br><span class="line">ZTEST(bluetooth_tests, test_bt_enable)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    </span><br><span class="line">    err = bt_enable(<span class="literal">NULL</span>);</span><br><span class="line">    zassert_equal(err, <span class="number">0</span>, <span class="string">&quot;Bluetooth enable failed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-系统测试"><a href="#4-系统测试" class="headerlink" title="4. 系统测试"></a>4. 系统测试</h2><h3 id="4-1-系统功能测试"><a href="#4-1-系统功能测试" class="headerlink" title="4.1 系统功能测试"></a>4.1 系统功能测试</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 线程测试 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">thread_entry</span><span class="params">(<span class="type">void</span> *p1, <span class="type">void</span> *p2, <span class="type">void</span> *p3)</span></span><br><span class="line">&#123;</span><br><span class="line">    k_sem_give((<span class="keyword">struct</span> k_sem *)p1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZTEST(thread_tests, test_thread_create)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">k_thread</span> <span class="title">thread</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">k_sem</span> <span class="title">sem</span>;</span></span><br><span class="line">    <span class="type">k_tid_t</span> tid;</span><br><span class="line">    </span><br><span class="line">    k_sem_init(&amp;sem, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    tid = k_thread_create(&amp;thread, stack_area,</span><br><span class="line">                         K_THREAD_STACK_SIZEOF(stack_area),</span><br><span class="line">                         thread_entry, &amp;sem, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">                         K_PRIO_PREEMPT(<span class="number">0</span>), <span class="number">0</span>, K_NO_WAIT);</span><br><span class="line">    </span><br><span class="line">    zassert_not_null(tid, <span class="string">&quot;Thread creation failed&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 等待线程完成 */</span></span><br><span class="line">    k_sem_take(&amp;sem, K_FOREVER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定时器测试 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">timer_handler</span><span class="params">(<span class="keyword">struct</span> k_timer *timer)</span></span><br><span class="line">&#123;</span><br><span class="line">    k_sem_give((<span class="keyword">struct</span> k_sem *)timer-&gt;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZTEST(timer_tests, test_timer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">k_timer</span> <span class="title">timer</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">k_sem</span> <span class="title">sem</span>;</span></span><br><span class="line">    </span><br><span class="line">    k_sem_init(&amp;sem, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    k_timer_init(&amp;timer, timer_handler, <span class="literal">NULL</span>);</span><br><span class="line">    timer.user_data = &amp;sem;</span><br><span class="line">    </span><br><span class="line">    k_timer_start(&amp;timer, K_MSEC(<span class="number">100</span>), K_NO_WAIT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 验证定时器触发 */</span></span><br><span class="line">    zassert_equal(k_sem_take(&amp;sem, K_MSEC(<span class="number">200</span>)), <span class="number">0</span>,</span><br><span class="line">                 <span class="string">&quot;Timer didn&#x27;t trigger&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-性能测试"><a href="#4-2-性能测试" class="headerlink" title="4.2 性能测试"></a>4.2 性能测试</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/timing/timing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">ZTEST(performance_tests, test_operation_timing)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> start_time, end_time;</span><br><span class="line">    <span class="type">uint32_t</span> cycles, ns;</span><br><span class="line">    </span><br><span class="line">    timing_start();</span><br><span class="line">    start_time = timing_counter_get();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 执行要测试的操作 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="comment">/* 测试代码 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    end_time = timing_counter_get();</span><br><span class="line">    cycles = timing_cycles_get(&amp;start_time, &amp;end_time);</span><br><span class="line">    ns = timing_cycles_to_ns(cycles);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 验证性能要求 */</span></span><br><span class="line">    zassert_true(ns &lt; <span class="number">1000000</span>,</span><br><span class="line">                 <span class="string">&quot;Operation took too long&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-覆盖率测试"><a href="#5-覆盖率测试" class="headerlink" title="5. 覆盖率测试"></a>5. 覆盖率测试</h2><h3 id="5-1-配置覆盖率"><a href="#5-1-配置覆盖率" class="headerlink" title="5.1 配置覆盖率"></a>5.1 配置覆盖率</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_COVERAGE=y</span><br><span class="line">CONFIG_COVERAGE_GCOV=y</span><br></pre></td></tr></table></figure>

<h3 id="5-2-生成覆盖率报告"><a href="#5-2-生成覆盖率报告" class="headerlink" title="5.2 生成覆盖率报告"></a>5.2 生成覆盖率报告</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译带覆盖率的测试</span></span><br><span class="line">west build -b qemu_x86 tests/kernel/threads/thread_apis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试</span></span><br><span class="line">west build -t run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成覆盖率报告</span></span><br><span class="line">gcovr -r . --html -o coverage.html</span><br></pre></td></tr></table></figure>

<h2 id="6-自动化测试"><a href="#6-自动化测试" class="headerlink" title="6. 自动化测试"></a>6. 自动化测试</h2><h3 id="6-1-测试脚本"><a href="#6-1-测试脚本" class="headerlink" title="6.1 测试脚本"></a>6.1 测试脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_test</span>(<span class="params">test_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;运行指定的测试&quot;&quot;&quot;</span></span><br><span class="line">    cmd = [<span class="string">&#x27;west&#x27;</span>, <span class="string">&#x27;build&#x27;</span>, <span class="string">&#x27;-b&#x27;</span>, <span class="string">&#x27;qemu_x86&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;tests/&#x27;</span> + test_name]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 编译测试</span></span><br><span class="line">    result = subprocess.run(cmd)</span><br><span class="line">    <span class="keyword">if</span> result.returncode != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Test <span class="subst">&#123;test_name&#125;</span> build failed&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行测试</span></span><br><span class="line">    cmd = [<span class="string">&#x27;west&#x27;</span>, <span class="string">&#x27;build&#x27;</span>, <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;run&#x27;</span>]</span><br><span class="line">    result = subprocess.run(cmd)</span><br><span class="line">    <span class="keyword">return</span> result.returncode == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tests = [</span><br><span class="line">        <span class="string">&#x27;kernel/threads/thread_apis&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;kernel/semaphore&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;kernel/timer&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    failed_tests = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> test <span class="keyword">in</span> tests:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> run_test(test):</span><br><span class="line">            failed_tests.append(test)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> failed_tests:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed tests:&quot;</span>, failed_tests)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;All tests passed!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="6-2-CI-CD集成"><a href="#6-2-CI-CD集成" class="headerlink" title="6.2 CI&#x2F;CD集成"></a>6.2 CI&#x2F;CD集成</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/tests.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Zephyr</span> <span class="string">Tests</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>, <span class="string">pull_request</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">test:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Python</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/setup-python@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">python-version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        pip install west</span></span><br><span class="line"><span class="string">        west init -m https://github.com/zephyrproject-rtos/zephyr</span></span><br><span class="line"><span class="string">        west update</span></span><br><span class="line"><span class="string"></span>    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">tests</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        ./scripts/run_tests.py</span></span><br><span class="line"><span class="string"></span>    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">coverage</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">coverage-report</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">coverage.html</span></span><br></pre></td></tr></table></figure>

<h2 id="7-测试最佳实践"><a href="#7-测试最佳实践" class="headerlink" title="7. 测试最佳实践"></a>7. 测试最佳实践</h2><h3 id="7-1-测试组织"><a href="#7-1-测试组织" class="headerlink" title="7.1 测试组织"></a>7.1 测试组织</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 按功能组织测试 */</span></span><br><span class="line">ZTEST_SUITE(kernel_tests, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">ZTEST_SUITE(driver_tests, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">ZTEST_SUITE(network_tests, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试用例命名约定 */</span></span><br><span class="line">ZTEST(kernel_tests, test_thread_creation)</span><br><span class="line">ZTEST(kernel_tests, test_thread_priority)</span><br><span class="line">ZTEST(kernel_tests, test_thread_scheduling)</span><br></pre></td></tr></table></figure>

<h3 id="7-2-测试文档"><a href="#7-2-测试文档" class="headerlink" title="7.2 测试文档"></a>7.2 测试文档</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 测试线程创建功能</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 测试目标:</span></span><br><span class="line"><span class="comment"> * - 验证线程创建是否成功</span></span><br><span class="line"><span class="comment"> * - 验证线程优先级设置</span></span><br><span class="line"><span class="comment"> * - 验证线程栈大小配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 测试步骤:</span></span><br><span class="line"><span class="comment"> * 1. 创建新线程</span></span><br><span class="line"><span class="comment"> * 2. 验证线程ID</span></span><br><span class="line"><span class="comment"> * 3. 检查线程状态</span></span><br><span class="line"><span class="comment"> * 4. 等待线程完成</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 预期结果:</span></span><br><span class="line"><span class="comment"> * - 线程创建成功</span></span><br><span class="line"><span class="comment"> * - 线程正常执行</span></span><br><span class="line"><span class="comment"> * - 线程正常退出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZTEST(thread_tests, test_thread_create)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 测试实现 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-调试测试失败"><a href="#8-调试测试失败" class="headerlink" title="8. 调试测试失败"></a>8. 调试测试失败</h2><h3 id="8-1-测试调试工具"><a href="#8-1-测试调试工具" class="headerlink" title="8.1 测试调试工具"></a>8.1 测试调试工具</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试辅助宏 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEST_CHECK(condition, fmt, ...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!(condition)) &#123; \</span></span><br><span class="line"><span class="meta">            ztest_test_fail(); \</span></span><br><span class="line"><span class="meta">            printk(<span class="string">&quot;Check failed: &quot;</span> fmt <span class="string">&quot;\n&quot;</span>, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 带调试信息的测试 */</span></span><br><span class="line">ZTEST(debug_tests, test_with_debug)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> value = calculate_something();</span><br><span class="line">    </span><br><span class="line">    TEST_CHECK(value == expected_value,</span><br><span class="line">              <span class="string">&quot;Value %d != expected %d&quot;</span>,</span><br><span class="line">              value, expected_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-测试日志分析"><a href="#8-2-测试日志分析" class="headerlink" title="8.2 测试日志分析"></a>8.2 测试日志分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/ztest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/logging/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">LOG_MODULE_REGISTER(test_log, LOG_LEVEL_DBG);</span><br><span class="line"></span><br><span class="line">ZTEST(log_tests, test_with_logging)</span><br><span class="line">&#123;</span><br><span class="line">    LOG_INF(<span class="string">&quot;Starting test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 测试步骤 */</span></span><br><span class="line">    <span class="type">int</span> result = perform_operation();</span><br><span class="line">    LOG_DBG(<span class="string">&quot;Operation result: %d&quot;</span>, result);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 验证结果 */</span></span><br><span class="line">    zassert_equal(result, expected_result,</span><br><span class="line">                 <span class="string">&quot;Operation failed&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    LOG_INF(<span class="string">&quot;Test completed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io">JoeNero</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/testing/README/">https://joeforkyou.github.io/2025/03/21/nodic/zephyr/testing/README/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/%E7%BE%8E%E5%A5%B3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/21/nodic/zephyr/toolchain/README/" title="README"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">README</div></div><div class="info-2"><div class="info-item-1">Zephyr 工具链本章节详细介绍了 Zephyr RTOS 开发所需的工具链，包括安装配置、构建系统、调试工具以及开发环境设置等内容。 目录 工具链安装  支持的操作系统 SDK 安装步骤 交叉编译器配置 常见问题解决   构建系统  CMake 构建流程 West 命令工具 构建配置选项 自定义构建   调试工具  GDB 调试 OpenOCD 配置 SEGGER J-Link 跟踪和分析   开发环境  Visual Studio Code 配置 Eclipse 集成 SEGGER Embedded Studio 命令行工具    工具链概述Zephyr RTOS 开发需要以下核心工具：  Zephyr SDK：包含交叉编译器、调试器和工具 West：Zephyr 的元工具，用于管理多仓库项目 CMake：构建系统 Ninja：构建工具 Python：脚本和工具依赖  支持的操作系统Zephyr 开发工具链支持以下操作系统：  Linux：Ubuntu, Fedora, Clear Linux OS macOS：10.15 Catalina...</div></div></div></a><a class="pagination-related" href="/2025/03/21/nodic/zephyr/toolchain/build_system/" title="build_system"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">build_system</div></div><div class="info-2"><div class="info-item-1">Zephyr 构建系统本文档详细介绍了 Zephyr RTOS 的构建系统，包括 CMake 构建流程、West 命令工具、构建配置选项以及自定义构建方法。 CMake 构建流程Zephyr 使用 CMake 作为其主要构建系统，结合 Ninja 或 Make 作为构建工具。 构建系统架构Zephyr 的构建系统由以下几个主要部分组成：  CMake 脚本：定义构建逻辑和目标 Kconfig 系统：管理配置选项 设备树：描述硬件配置 West：元构建工具，简化命令行操作  基本构建流程Zephyr 应用程序的构建流程如下：  配置阶段  处理 Kconfig 选项 解析设备树源文件 生成构建系统缓存   生成阶段  生成构建规则 创建构建目标   构建阶段  编译源代码 链接目标文件 生成最终二进制文件    CMake 脚本结构Zephyr 项目的 CMake 脚本组织结构：  zephyr&#x2F;CMakeLists.txt：主 CMake...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">JoeNero</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">126</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/JoeForkYou"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/JoeForkYou" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:17549663745@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">wow!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zephyr-%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">Zephyr 系统测试指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1. 测试框架概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%B5%8B%E8%AF%95%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 测试架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%B5%8B%E8%AF%95%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 测试配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">2. 单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%9F%BA%E6%9C%AC%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 基本测试用例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%B5%8B%E8%AF%95%E5%A4%B9%E5%85%B7"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 测试夹具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">3. 集成测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 设备驱动测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 协议栈测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.</span> <span class="toc-text">4. 系统测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 系统功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 性能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%A6%86%E7%9B%96%E7%8E%87%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.</span> <span class="toc-text">5. 覆盖率测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E9%85%8D%E7%BD%AE%E8%A6%86%E7%9B%96%E7%8E%87"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 配置覆盖率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%94%9F%E6%88%90%E8%A6%86%E7%9B%96%E7%8E%87%E6%8A%A5%E5%91%8A"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 生成覆盖率报告</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.</span> <span class="toc-text">6. 自动化测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 测试脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-CI-CD%E9%9B%86%E6%88%90"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 CI&#x2F;CD集成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%B5%8B%E8%AF%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.7.</span> <span class="toc-text">7. 测试最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%B5%8B%E8%AF%95%E7%BB%84%E7%BB%87"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 测试组织</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 测试文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E8%B0%83%E8%AF%95%E6%B5%8B%E8%AF%95%E5%A4%B1%E8%B4%A5"><span class="toc-number">1.8.</span> <span class="toc-text">8. 调试测试失败</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E6%B5%8B%E8%AF%95%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 测试调试工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E6%B5%8B%E8%AF%95%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 测试日志分析</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/drivers/" title="drivers">drivers</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/filesystem/" title="filesystem">filesystem</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/hardware/" title="hardware">hardware</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/kernel/" title="kernel">kernel</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/networking/" title="networking">networking</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By JoeNero</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>