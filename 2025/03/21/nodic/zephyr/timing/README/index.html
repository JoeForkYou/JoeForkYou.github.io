<!DOCTYPE html><html lang="cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Zephyr 定时系统指南 | JoeNero的博客</title><meta name="author" content="JoeNero"><meta name="copyright" content="JoeNero"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Zephyr 时间管理指南1. 时间管理配置1.1 基础配置 (prj.conf)1234567891011121314# 系统时钟配置CONFIG_SYS_CLOCK_TICKS_PER_SEC&#x3D;1000CONFIG_TICKLESS_KERNEL&#x3D;y# 定时器配置CONFIG_TIMER_HAS_64BIT_CYCLE_COUNTER&#x3D;yCONFIG_TIMER_READS_ITS_FREQU">
<meta property="og:type" content="article">
<meta property="og:title" content="Zephyr 定时系统指南">
<meta property="og:url" content="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/timing/README/index.html">
<meta property="og:site_name" content="JoeNero的博客">
<meta property="og:description" content="Zephyr 时间管理指南1. 时间管理配置1.1 基础配置 (prj.conf)1234567891011121314# 系统时钟配置CONFIG_SYS_CLOCK_TICKS_PER_SEC&#x3D;1000CONFIG_TICKLESS_KERNEL&#x3D;y# 定时器配置CONFIG_TIMER_HAS_64BIT_CYCLE_COUNTER&#x3D;yCONFIG_TIMER_READS_ITS_FREQU">
<meta property="og:locale">
<meta property="og:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg">
<meta property="article:published_time" content="2025-03-21T12:49:56.000Z">
<meta property="article:modified_time" content="2025-03-21T14:17:45.316Z">
<meta property="article:author" content="JoeNero">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg"><link rel="shortcut icon" href="/img/1.jpg"><link rel="canonical" href="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/timing/README/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"IZ845G3SQG","apiKey":"381e98702820650923216a5f47f18d71","indexName":"movie","hitsPerPage":6,"languages":{"input_placeholder":"Search for Posts","hits_empty":"No results found for: ${query}","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Zephyr 定时系统指南',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="JoeNero的博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">126</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">JoeNero的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Zephyr 定时系统指南</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Zephyr 定时系统指南</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-21T14:17:45.316Z" title="Updated 2025-03-21 22:17:45">2025-03-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Zephyr-时间管理指南"><a href="#Zephyr-时间管理指南" class="headerlink" title="Zephyr 时间管理指南"></a>Zephyr 时间管理指南</h1><h2 id="1-时间管理配置"><a href="#1-时间管理配置" class="headerlink" title="1. 时间管理配置"></a>1. 时间管理配置</h2><h3 id="1-1-基础配置-prj-conf"><a href="#1-1-基础配置-prj-conf" class="headerlink" title="1.1 基础配置 (prj.conf)"></a>1.1 基础配置 (prj.conf)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 系统时钟配置</span><br><span class="line">CONFIG_SYS_CLOCK_TICKS_PER_SEC=1000</span><br><span class="line">CONFIG_TICKLESS_KERNEL=y</span><br><span class="line"></span><br><span class="line"># 定时器配置</span><br><span class="line">CONFIG_TIMER_HAS_64BIT_CYCLE_COUNTER=y</span><br><span class="line">CONFIG_TIMER_READS_ITS_FREQUENCY_AT_RUNTIME=y</span><br><span class="line"></span><br><span class="line"># RTC配置（如果使用）</span><br><span class="line">CONFIG_COUNTER=y</span><br><span class="line">CONFIG_COUNTER_RTC0=y</span><br><span class="line"></span><br><span class="line"># 时间测量配置</span><br><span class="line">CONFIG_TIMING_FUNCTIONS=y</span><br></pre></td></tr></table></figure>

<h3 id="1-2-时钟源配置-boards-xxx-overlay"><a href="#1-2-时钟源配置-boards-xxx-overlay" class="headerlink" title="1.2 时钟源配置 (boards&#x2F;xxx.overlay)"></a>1.2 时钟源配置 (boards&#x2F;xxx.overlay)</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="title class_">soc</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">        timer0:</span> <span class="title class_">timer@40000000</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;nordic,nrf-timer&quot;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x40000000</span> <span class="number">0x1000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">interrupts</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">8</span> <span class="number">1</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">            <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">        <span class="punctuation">&#125;;</span></span><br><span class="line">    <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-基本时间操作"><a href="#2-基本时间操作" class="headerlink" title="2. 基本时间操作"></a>2. 基本时间操作</h2><h3 id="2-1-延时函数"><a href="#2-1-延时函数" class="headerlink" title="2.1 延时函数"></a>2.1 延时函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 毫秒延时 */</span></span><br><span class="line">    k_msleep(<span class="number">1000</span>);    <span class="comment">// 延时1秒</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 微秒延时 */</span></span><br><span class="line">    k_usleep(<span class="number">1000</span>);    <span class="comment">// 延时1毫秒</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 纳秒延时 */</span></span><br><span class="line">    k_nsleep(<span class="number">1000</span>);    <span class="comment">// 延时1微秒</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 忙等待延时 */</span></span><br><span class="line">    k_busy_wait(<span class="number">1000</span>); <span class="comment">// 延时1微秒（不释放CPU）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 自定义时间单位延时 */</span></span><br><span class="line">    k_sleep(K_SECONDS(<span class="number">1</span>));     <span class="comment">// 1秒</span></span><br><span class="line">    k_sleep(K_MSEC(<span class="number">500</span>));      <span class="comment">// 500毫秒</span></span><br><span class="line">    k_sleep(K_MINUTES(<span class="number">1</span>));     <span class="comment">// 1分钟</span></span><br><span class="line">    k_sleep(K_HOURS(<span class="number">1</span>));       <span class="comment">// 1小时</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-时间获取"><a href="#2-2-时间获取" class="headerlink" title="2.2 时间获取"></a>2.2 时间获取</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">time_get_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 获取系统启动后的时间 */</span></span><br><span class="line">    <span class="type">int64_t</span> uptime = k_uptime_get();</span><br><span class="line">    printk(<span class="string">&quot;System uptime: %lld ms\n&quot;</span>, uptime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取32位系统时间 */</span></span><br><span class="line">    <span class="type">uint32_t</span> uptime32 = k_uptime_get_32();</span><br><span class="line">    printk(<span class="string">&quot;System uptime (32-bit): %u ms\n&quot;</span>, uptime32);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取CPU cycles */</span></span><br><span class="line">    <span class="type">uint32_t</span> cycles = k_cycle_get_32();</span><br><span class="line">    printk(<span class="string">&quot;CPU cycles: %u\n&quot;</span>, cycles);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取64位CPU cycles */</span></span><br><span class="line">    <span class="type">uint64_t</span> cycles64 = k_cycle_get_64();</span><br><span class="line">    printk(<span class="string">&quot;CPU cycles (64-bit): %llu\n&quot;</span>, cycles64);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-定时器管理"><a href="#3-定时器管理" class="headerlink" title="3. 定时器管理"></a>3. 定时器管理</h2><h3 id="3-1-基本定时器"><a href="#3-1-基本定时器" class="headerlink" title="3.1 基本定时器"></a>3.1 基本定时器</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义定时器 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">k_timer</span> <span class="title">my_timer</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定时器回调函数 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_handler</span><span class="params">(<span class="keyword">struct</span> k_timer *timer)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;Timer expired!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定时器停止回调函数 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_stop_handler</span><span class="params">(<span class="keyword">struct</span> k_timer *timer)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;Timer stopped!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 初始化定时器 */</span></span><br><span class="line">    k_timer_init(&amp;my_timer, timer_handler, timer_stop_handler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 启动定时器（2秒后触发，每1秒重复） */</span></span><br><span class="line">    k_timer_start(&amp;my_timer, K_SECONDS(<span class="number">2</span>), K_SECONDS(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 等待定时器触发 */</span></span><br><span class="line">    k_timer_status_sync(&amp;my_timer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取剩余时间 */</span></span><br><span class="line">    <span class="type">uint32_t</span> remaining = k_timer_remaining_get(&amp;my_timer);</span><br><span class="line">    printk(<span class="string">&quot;Remaining time: %u ms\n&quot;</span>, remaining);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 停止定时器 */</span></span><br><span class="line">    k_timer_stop(&amp;my_timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-高精度定时器"><a href="#3-2-高精度定时器" class="headerlink" title="3.2 高精度定时器"></a>3.2 高精度定时器</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/timing/timing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">high_precision_timer</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> start_time, end_time;</span><br><span class="line">    <span class="type">uint32_t</span> cycles, ns;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化timing系统 */</span></span><br><span class="line">    timing_init();</span><br><span class="line">    timing_start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取开始时间 */</span></span><br><span class="line">    start_time = timing_counter_get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 执行需要测量的操作 */</span></span><br><span class="line">    k_busy_wait(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取结束时间 */</span></span><br><span class="line">    end_time = timing_counter_get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 计算时间差 */</span></span><br><span class="line">    cycles = timing_cycles_get(&amp;start_time, &amp;end_time);</span><br><span class="line">    ns = timing_cycles_to_ns(cycles);</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;Operation took %u cycles (%u ns)\n&quot;</span>, cycles, ns);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-实时时钟-RTC"><a href="#4-实时时钟-RTC" class="headerlink" title="4. 实时时钟(RTC)"></a>4. 实时时钟(RTC)</h2><h3 id="4-1-RTC操作"><a href="#4-1-RTC操作" class="headerlink" title="4.1 RTC操作"></a>4.1 RTC操作</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/drivers/counter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rtc_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">rtc</span>;</span></span><br><span class="line">    <span class="type">uint32_t</span> now;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取RTC设备 */</span></span><br><span class="line">    rtc = DEVICE_DT_GET(DT_NODELABEL(rtc0));</span><br><span class="line">    <span class="keyword">if</span> (!device_is_ready(rtc)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;RTC device not ready\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取当前计数值 */</span></span><br><span class="line">    ret = counter_get_value(rtc, &amp;now);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to get counter value\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 转换为时间戳 */</span></span><br><span class="line">    <span class="type">time_t</span> timestamp = counter_ticks_to_us(rtc, now) / <span class="number">1000000</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">time_info</span> =</span> localtime(&amp;timestamp);</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;Current time: %02d:%02d:%02d\n&quot;</span>,</span><br><span class="line">           time_info-&gt;tm_hour,</span><br><span class="line">           time_info-&gt;tm_min,</span><br><span class="line">           time_info-&gt;tm_sec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-RTC闹钟"><a href="#4-2-RTC闹钟" class="headerlink" title="4.2 RTC闹钟"></a>4.2 RTC闹钟</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/drivers/counter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 闹钟回调函数 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">alarm_callback</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params">                         <span class="type">uint8_t</span> chan_id,</span></span><br><span class="line"><span class="params">                         <span class="type">uint32_t</span> ticks,</span></span><br><span class="line"><span class="params">                         <span class="type">void</span> *user_data)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;Alarm triggered!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rtc_alarm_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">rtc</span>;</span></span><br><span class="line">    <span class="type">uint32_t</span> now;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    rtc = DEVICE_DT_GET(DT_NODELABEL(rtc0));</span><br><span class="line">    <span class="keyword">if</span> (!device_is_ready(rtc)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取当前时间 */</span></span><br><span class="line">    ret = counter_get_value(rtc, &amp;now);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置闹钟 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">counter_alarm_cfg</span> <span class="title">alarm_cfg</span> =</span> &#123;</span><br><span class="line">        .callback = alarm_callback,</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">        .ticks = now + counter_us_to_ticks(rtc, <span class="number">5000000</span>) <span class="comment">/* 5秒后触发 */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ret = counter_set_channel_alarm(rtc, <span class="number">0</span>, &amp;alarm_cfg);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to set alarm\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-周期性任务"><a href="#5-周期性任务" class="headerlink" title="5. 周期性任务"></a>5. 周期性任务</h2><h3 id="5-1-工作队列定时器"><a href="#5-1-工作队列定时器" class="headerlink" title="5.1 工作队列定时器"></a>5.1 工作队列定时器</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义工作队列 */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">k_work_q</span> <span class="title">my_work_q</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">K_THREAD_STACK_DEFINE</span><span class="params">(my_work_q_stack, <span class="number">1024</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义延迟工作 */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">k_work_delayable</span> <span class="title">delayed_work</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 工作处理函数 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">work_handler</span><span class="params">(<span class="keyword">struct</span> k_work *work)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;Periodic work executed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 重新调度下一次执行 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">k_work_delayable</span> *<span class="title">dwork</span> =</span> k_work_delayable_from_work(work);</span><br><span class="line">    k_work_schedule_for_queue(&amp;my_work_q, dwork, K_SECONDS(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">periodic_work_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 初始化工作队列 */</span></span><br><span class="line">    k_work_queue_init(&amp;my_work_q);</span><br><span class="line">    k_work_queue_start(&amp;my_work_q, my_work_q_stack,</span><br><span class="line">                      K_THREAD_STACK_SIZEOF(my_work_q_stack),</span><br><span class="line">                      K_PRIO_PREEMPT(<span class="number">10</span>), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化延迟工作 */</span></span><br><span class="line">    k_work_init_delayable(&amp;delayed_work, work_handler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 开始周期性任务 */</span></span><br><span class="line">    k_work_schedule_for_queue(&amp;my_work_q, &amp;delayed_work, K_NO_WAIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-定时器线程"><a href="#5-2-定时器线程" class="headerlink" title="5.2 定时器线程"></a>5.2 定时器线程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义线程栈 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STACK_SIZE 1024</span></span><br><span class="line">K_THREAD_STACK_DEFINE(timer_stack, STACK_SIZE);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">k_thread</span> <span class="title">timer_thread_data</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 线程入口函数 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_thread</span><span class="params">(<span class="type">void</span> *p1, <span class="type">void</span> *p2, <span class="type">void</span> *p3)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* 执行周期性任务 */</span></span><br><span class="line">        printk(<span class="string">&quot;Timer thread running\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 精确延时 */</span></span><br><span class="line">        k_msleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_thread_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 创建定时器线程 */</span></span><br><span class="line">    k_thread_create(&amp;timer_thread_data, timer_stack,</span><br><span class="line">                    STACK_SIZE,</span><br><span class="line">                    timer_thread,</span><br><span class="line">                    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">                    K_PRIO_PREEMPT(<span class="number">10</span>), <span class="number">0</span>, K_NO_WAIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-时间同步"><a href="#6-时间同步" class="headerlink" title="6. 时间同步"></a>6. 时间同步</h2><h3 id="6-1-时间同步配置"><a href="#6-1-时间同步配置" class="headerlink" title="6.1 时间同步配置"></a>6.1 时间同步配置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/net/sntp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">time_sync_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sntp_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">uint64_t</span> epoch_time;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置SNTP服务器地址 */</span></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(<span class="number">123</span>);</span><br><span class="line">    inet_pton(AF_INET, <span class="string">&quot;pool.ntp.org&quot;</span>, &amp;addr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化SNTP */</span></span><br><span class="line">    ret = sntp_init(&amp;ctx);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取时间 */</span></span><br><span class="line">    ret = sntp_query(&amp;ctx, (<span class="keyword">struct</span> sockaddr *)&amp;addr,</span><br><span class="line">                     <span class="keyword">sizeof</span>(addr), &amp;epoch_time);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        sntp_close(&amp;ctx);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置系统时间 */</span></span><br><span class="line">    printk(<span class="string">&quot;Time synchronized: %llu\n&quot;</span>, epoch_time);</span><br><span class="line">    sntp_close(&amp;ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-时区管理"><a href="#6-2-时区管理" class="headerlink" title="6.2 时区管理"></a>6.2 时区管理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timezone_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">time_t</span> now;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">time_info</span>;</span></span><br><span class="line">    <span class="type">char</span> time_str[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取当前时间戳 */</span></span><br><span class="line">    time(&amp;now);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 转换为本地时间 */</span></span><br><span class="line">    time_info = localtime(&amp;now);</span><br><span class="line">    strftime(time_str, <span class="keyword">sizeof</span>(time_str),</span><br><span class="line">             <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time_info);</span><br><span class="line">    printk(<span class="string">&quot;Local time: %s\n&quot;</span>, time_str);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 转换为UTC时间 */</span></span><br><span class="line">    time_info = gmtime(&amp;now);</span><br><span class="line">    strftime(time_str, <span class="keyword">sizeof</span>(time_str),</span><br><span class="line">             <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time_info);</span><br><span class="line">    printk(<span class="string">&quot;UTC time: %s\n&quot;</span>, time_str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-性能优化"><a href="#7-性能优化" class="headerlink" title="7. 性能优化"></a>7. 性能优化</h2><h3 id="7-1-时间测量优化"><a href="#7-1-时间测量优化" class="headerlink" title="7.1 时间测量优化"></a>7.1 时间测量优化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/timing/timing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">optimized_timing</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> start, end;</span><br><span class="line">    <span class="type">uint32_t</span> min_time = UINT32_MAX;</span><br><span class="line">    <span class="type">uint32_t</span> max_time = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint32_t</span> total_time = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 预热CPU缓存 */</span></span><br><span class="line">    k_busy_wait(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 多次测量以获得统计数据 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        start = k_cycle_get_32();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 被测量的代码 */</span></span><br><span class="line">        k_busy_wait(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        end = k_cycle_get_32();</span><br><span class="line">        <span class="type">uint32_t</span> elapsed = end - start;</span><br><span class="line"></span><br><span class="line">        min_time = MIN(min_time, elapsed);</span><br><span class="line">        max_time = MAX(max_time, elapsed);</span><br><span class="line">        total_time += elapsed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;Timing statistics:\n&quot;</span>);</span><br><span class="line">    printk(<span class="string">&quot;Min: %u cycles\n&quot;</span>, min_time);</span><br><span class="line">    printk(<span class="string">&quot;Max: %u cycles\n&quot;</span>, max_time);</span><br><span class="line">    printk(<span class="string">&quot;Avg: %u cycles\n&quot;</span>, total_time / count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-定时器优化"><a href="#7-2-定时器优化" class="headerlink" title="7.2 定时器优化"></a>7.2 定时器优化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用静态定义的定时器 */</span></span><br><span class="line">K_TIMER_DEFINE(static_timer, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定时器池 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER_POOL_SIZE 4</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">k_timer</span> <span class="title">timer_pool</span>[<span class="title">TIMER_POOL_SIZE</span>];</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> timer_used[TIMER_POOL_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 从池中获取定时器 */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> k_timer *<span class="title function_">get_timer</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; TIMER_POOL_SIZE; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!timer_used[i]) &#123;</span><br><span class="line">            timer_used[i] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> &amp;timer_pool[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 释放定时器回池 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">release_timer</span><span class="params">(<span class="keyword">struct</span> k_timer *timer)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; TIMER_POOL_SIZE; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (timer == &amp;timer_pool[i]) &#123;</span><br><span class="line">            timer_used[i] = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_pool_example</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">k_timer</span> *<span class="title">timer</span> =</span> get_timer();</span><br><span class="line">    <span class="keyword">if</span> (timer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* 使用定时器 */</span></span><br><span class="line">        k_timer_start(timer, K_SECONDS(<span class="number">1</span>), K_NO_WAIT);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 停止并释放定时器 */</span></span><br><span class="line">        k_timer_stop(timer);</span><br><span class="line">        release_timer(timer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io">JoeNero</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/timing/README/">https://joeforkyou.github.io/2025/03/21/nodic/zephyr/timing/README/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/%E7%BE%8E%E5%A5%B3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/21/nodic/zephyr/shell/README/" title="Zephyr Shell 命令系统指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Zephyr Shell 命令系统指南</div></div><div class="info-2"><div class="info-item-1">Zephyr Shell 命令系统指南1. Shell系统架构1.1 整体架构123456789101112graph TD    A[用户输入] --&gt; B[Shell核心]    B --&gt; C[命令处理器]    C --&gt; D[命令实现]    D --&gt; E[系统功能]        subgraph &quot;Shell组件&quot;        F[命令注册]        G[参数解析]        H[历史记录]        I[自动完成]    end  1.2 基本配置1234567891011121314# Shell基本支持CONFIG_SHELL=y# 历史记录支持CONFIG_SHELL_HISTORY=y# 通配符支持CONFIG_SHELL_WILDCARD=y# 命令日志CONFIG_SHELL_LOGGING=y# 彩色输出CONFIG_SHELL_VT100_COLORS=y  2. 命令实现2.1 基本命令1234567891011121314#include...</div></div></div></a><a class="pagination-related" href="/2025/03/21/nodic/zephyr/toolchain/README/" title="Zephyr 工具链指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Zephyr 工具链指南</div></div><div class="info-2"><div class="info-item-1">Zephyr 工具链本章节详细介绍了 Zephyr RTOS 开发所需的工具链，包括安装配置、构建系统、调试工具以及开发环境设置等内容。 目录 工具链安装  构建系统  调试工具  开发环境  常见问题解决   构建系统  CMake 构建流程 West 命令工具 构建配置选项 自定义构建   调试工具  GDB 调试 OpenOCD 配置 SEGGER J-Link 跟踪和分析   开发环境  Visual Studio Code 配置 Eclipse 集成 SEGGER Embedded Studio 命令行工具    工具链概述Zephyr RTOS 开发需要以下核心工具：  Zephyr SDK：包含交叉编译器、调试器和工具 West：Zephyr 的元工具，用于管理多仓库项目 CMake：构建系统 Ninja：构建工具 Python：脚本和工具依赖  支持的操作系统Zephyr 开发工具链支持以下操作系统：  Linux：Ubuntu, Fedora, Clear Linux OS macOS：10.15 Catalina 及更高版本 Windows：Windows...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">JoeNero</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">126</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/JoeForkYou"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/JoeForkYou" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:17549663745@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">wow!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zephyr-%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">Zephyr 时间管理指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">1. 时间管理配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE-prj-conf"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 基础配置 (prj.conf)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%97%B6%E9%92%9F%E6%BA%90%E9%85%8D%E7%BD%AE-boards-xxx-overlay"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 时钟源配置 (boards&#x2F;xxx.overlay)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9F%BA%E6%9C%AC%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C"><span class="toc-number">1.2.</span> <span class="toc-text">2. 基本时间操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%BB%B6%E6%97%B6%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 延时函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%97%B6%E9%97%B4%E8%8E%B7%E5%8F%96"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 时间获取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%9A%E6%97%B6%E5%99%A8%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">3. 定时器管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%9F%BA%E6%9C%AC%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 基本定时器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E9%AB%98%E7%B2%BE%E5%BA%A6%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 高精度定时器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%9E%E6%97%B6%E6%97%B6%E9%92%9F-RTC"><span class="toc-number">1.4.</span> <span class="toc-text">4. 实时时钟(RTC)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-RTC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 RTC操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-RTC%E9%97%B9%E9%92%9F"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 RTC闹钟</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%91%A8%E6%9C%9F%E6%80%A7%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">5. 周期性任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 工作队列定时器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%AE%9A%E6%97%B6%E5%99%A8%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 定时器线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-number">1.6.</span> <span class="toc-text">6. 时间同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 时间同步配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%97%B6%E5%8C%BA%E7%AE%A1%E7%90%86"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 时区管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.</span> <span class="toc-text">7. 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%97%B6%E9%97%B4%E6%B5%8B%E9%87%8F%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 时间测量优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%AE%9A%E6%97%B6%E5%99%A8%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 定时器优化</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/drivers/" title="drivers">drivers</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/filesystem/" title="filesystem">filesystem</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/hardware/" title="hardware">hardware</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/kernel/" title="kernel">kernel</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/core/networking/" title="networking">networking</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By JoeNero</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>