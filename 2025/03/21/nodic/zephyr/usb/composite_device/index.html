<!DOCTYPE html><html lang="cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>composite_device | JoeNero的博客</title><meta name="author" content="JoeNero"><meta name="copyright" content="JoeNero"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Zephyr USB 复合设备指南1. 复合设备基础复合设备是指在单个物理 USB 设备中包含多个功能类的设备。例如，一个设备可以同时实现 CDC-ACM（串口）、HID（键盘&#x2F;鼠标）和 MSC（存储）功能。 1.1 复合设备配置 (prj.conf)12345678910111213141516171819# USB 设备栈基础配置CONFIG_USB_DEVICE_STACK&#x3D;yCO">
<meta property="og:type" content="article">
<meta property="og:title" content="composite_device">
<meta property="og:url" content="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/usb/composite_device/index.html">
<meta property="og:site_name" content="JoeNero的博客">
<meta property="og:description" content="Zephyr USB 复合设备指南1. 复合设备基础复合设备是指在单个物理 USB 设备中包含多个功能类的设备。例如，一个设备可以同时实现 CDC-ACM（串口）、HID（键盘&#x2F;鼠标）和 MSC（存储）功能。 1.1 复合设备配置 (prj.conf)12345678910111213141516171819# USB 设备栈基础配置CONFIG_USB_DEVICE_STACK&#x3D;yCO">
<meta property="og:locale">
<meta property="og:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg">
<meta property="article:published_time" content="2025-03-21T12:49:56.000Z">
<meta property="article:modified_time" content="2025-03-21T13:20:53.528Z">
<meta property="article:author" content="JoeNero">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://joeforkyou.github.io/img/%E7%BE%8E%E5%A5%B3.jpg"><link rel="shortcut icon" href="/img/1.jpg"><link rel="canonical" href="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/usb/composite_device/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"IZ845G3SQG","apiKey":"381e98702820650923216a5f47f18d71","indexName":"movie","hitsPerPage":6,"languages":{"input_placeholder":"Search for Posts","hits_empty":"No results found for: ${query}","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'composite_device',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="JoeNero的博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">127</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">JoeNero的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">composite_device</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">composite_device</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-21T13:20:53.528Z" title="Updated 2025-03-21 21:20:53">2025-03-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Zephyr-USB-复合设备指南"><a href="#Zephyr-USB-复合设备指南" class="headerlink" title="Zephyr USB 复合设备指南"></a>Zephyr USB 复合设备指南</h1><h2 id="1-复合设备基础"><a href="#1-复合设备基础" class="headerlink" title="1. 复合设备基础"></a>1. 复合设备基础</h2><p>复合设备是指在单个物理 USB 设备中包含多个功能类的设备。例如，一个设备可以同时实现 CDC-ACM（串口）、HID（键盘&#x2F;鼠标）和 MSC（存储）功能。</p>
<h3 id="1-1-复合设备配置-prj-conf"><a href="#1-1-复合设备配置-prj-conf" class="headerlink" title="1.1 复合设备配置 (prj.conf)"></a>1.1 复合设备配置 (prj.conf)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># USB 设备栈基础配置</span><br><span class="line">CONFIG_USB_DEVICE_STACK=y</span><br><span class="line">CONFIG_USB_COMPOSITE_DEVICE=y</span><br><span class="line"></span><br><span class="line"># 复合设备类配置</span><br><span class="line">CONFIG_USB_CDC_ACM=y</span><br><span class="line">CONFIG_USB_HID=y</span><br><span class="line">CONFIG_USB_MASS_STORAGE=y</span><br><span class="line"></span><br><span class="line"># 复合设备描述符配置</span><br><span class="line">CONFIG_USB_DEVICE_MANUFACTURER=&quot;Zephyr&quot;</span><br><span class="line">CONFIG_USB_DEVICE_PRODUCT=&quot;Composite Device&quot;</span><br><span class="line">CONFIG_USB_DEVICE_VID=0x2FE3</span><br><span class="line">CONFIG_USB_DEVICE_PID=0x0200</span><br><span class="line">CONFIG_USB_DEVICE_SN=&quot;0123456789ABCDEF&quot;</span><br><span class="line"></span><br><span class="line"># 接口配置</span><br><span class="line">CONFIG_USB_MAX_NUM_INTERFACES=8</span><br><span class="line">CONFIG_USB_COMPOSITE_BUFFER_SIZE=512</span><br></pre></td></tr></table></figure>

<h3 id="1-2-复合设备描述符结构"><a href="#1-2-复合设备描述符结构" class="headerlink" title="1.2 复合设备描述符结构"></a>1.2 复合设备描述符结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_cdc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_hid.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_msc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 配置描述符结构 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_composite_desc</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_cfg_descriptor</span> <span class="title">cfg_desc</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* CDC-ACM 接口描述符 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_if_descriptor</span> <span class="title">if0</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_ep_descriptor</span> <span class="title">if0_in_ep</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_ep_descriptor</span> <span class="title">if0_out_ep</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* HID 接口描述符 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_if_descriptor</span> <span class="title">if1</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_ep_descriptor</span> <span class="title">if1_in_ep</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* MSC 接口描述符 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_if_descriptor</span> <span class="title">if2</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_ep_descriptor</span> <span class="title">if2_in_ep</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_ep_descriptor</span> <span class="title">if2_out_ep</span>;</span></span><br><span class="line">&#125; __packed;</span><br></pre></td></tr></table></figure>

<h2 id="2-复合设备实现"><a href="#2-复合设备实现" class="headerlink" title="2. 复合设备实现"></a>2. 复合设备实现</h2><h3 id="2-1-设备描述符定义"><a href="#2-1-设备描述符定义" class="headerlink" title="2.1 设备描述符定义"></a>2.1 设备描述符定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_common.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设备描述符 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_descriptor</span> <span class="title">dev_desc</span> =</span> &#123;</span><br><span class="line">    .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_device_descriptor),</span><br><span class="line">    .bDescriptorType = USB_DESC_DEVICE,</span><br><span class="line">    .bcdUSB = sys_cpu_to_le16(USB_2_0),</span><br><span class="line">    .bDeviceClass = USB_BCC_MISCELLANEOUS,</span><br><span class="line">    .bDeviceSubClass = <span class="number">0x02</span>,</span><br><span class="line">    .bDeviceProtocol = <span class="number">0x01</span>,</span><br><span class="line">    .bMaxPacketSize0 = USB_MAX_PACKET_SIZE,</span><br><span class="line">    .idVendor = sys_cpu_to_le16(CONFIG_USB_DEVICE_VID),</span><br><span class="line">    .idProduct = sys_cpu_to_le16(CONFIG_USB_DEVICE_PID),</span><br><span class="line">    .bcdDevice = sys_cpu_to_le16(<span class="number">0x0100</span>),</span><br><span class="line">    .iManufacturer = <span class="number">1</span>,</span><br><span class="line">    .iProduct = <span class="number">2</span>,</span><br><span class="line">    .iSerialNumber = <span class="number">3</span>,</span><br><span class="line">    .bNumConfigurations = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 配置描述符 */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_composite_desc</span> <span class="title">desc</span> =</span> &#123;</span><br><span class="line">    .cfg_desc = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_cfg_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_CONFIGURATION,</span><br><span class="line">        .wTotalLength = <span class="number">0</span>, <span class="comment">/* 将在运行时计算 */</span></span><br><span class="line">        .bNumInterfaces = <span class="number">3</span>, <span class="comment">/* CDC + HID + MSC */</span></span><br><span class="line">        .bConfigurationValue = <span class="number">1</span>,</span><br><span class="line">        .iConfiguration = <span class="number">0</span>,</span><br><span class="line">        .bmAttributes = USB_CONFIG_ATT_ONE | USB_CONFIG_ATT_SELF_POWERED,</span><br><span class="line">        .bMaxPower = <span class="number">50</span>, <span class="comment">/* 100 mA */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/* 各个接口描述符在子系统中定义 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 语言 ID 描述符 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint8_t</span> lang_desc[] = &#123;</span><br><span class="line">    <span class="number">4</span>,</span><br><span class="line">    USB_DESC_STRING,</span><br><span class="line">    <span class="number">0x09</span>, <span class="number">0x04</span> <span class="comment">/* 英语 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 厂商字符串描述符 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint8_t</span> mfr_desc[] = &#123;</span><br><span class="line">    USB_STRING_DESC_SIZE(CONFIG_USB_DEVICE_MANUFACTURER),</span><br><span class="line">    USB_DESC_STRING,</span><br><span class="line">    <span class="string">&#x27;Z&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;p&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;h&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;y&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;r&#x27;</span>, <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 产品字符串描述符 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint8_t</span> product_desc[] = &#123;</span><br><span class="line">    USB_STRING_DESC_SIZE(CONFIG_USB_DEVICE_PRODUCT),</span><br><span class="line">    USB_DESC_STRING,</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;o&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;m&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;p&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;o&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;s&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;i&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;t&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;v&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;i&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;c&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 序列号字符串描述符 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint8_t</span> sn_desc[] = &#123;</span><br><span class="line">    USB_STRING_DESC_SIZE(CONFIG_USB_DEVICE_SN),</span><br><span class="line">    USB_DESC_STRING,</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;2&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;3&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;4&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;5&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;6&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;7&#x27;</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;8&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;9&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;C&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;D&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;E&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;F&#x27;</span>, <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 描述符列表 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_desc_header</span> *<span class="title">desc_list</span>[] =</span> &#123;</span><br><span class="line">    (<span class="keyword">struct</span> usb_desc_header *)&amp;dev_desc,</span><br><span class="line">    (<span class="keyword">struct</span> usb_desc_header *)&amp;desc,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 字符串描述符列表 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_desc_header</span> *<span class="title">string_desc</span>[] =</span> &#123;</span><br><span class="line">    (<span class="keyword">struct</span> usb_desc_header *)lang_desc,</span><br><span class="line">    (<span class="keyword">struct</span> usb_desc_header *)mfr_desc,</span><br><span class="line">    (<span class="keyword">struct</span> usb_desc_header *)product_desc,</span><br><span class="line">    (<span class="keyword">struct</span> usb_desc_header *)sn_desc,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-复合设备初始化"><a href="#2-2-复合设备初始化" class="headerlink" title="2.2 复合设备初始化"></a>2.2 复合设备初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* USB 设备状态回调 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">composite_status_cb</span><span class="params">(<span class="keyword">enum</span> usb_dc_status_code status, <span class="type">const</span> <span class="type">uint8_t</span> *param)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">    <span class="keyword">case</span> USB_DC_RESET:</span><br><span class="line">        printk(<span class="string">&quot;USB Reset\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> USB_DC_CONNECTED:</span><br><span class="line">        printk(<span class="string">&quot;USB Connected\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> USB_DC_CONFIGURED:</span><br><span class="line">        printk(<span class="string">&quot;USB Configured\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> USB_DC_DISCONNECTED:</span><br><span class="line">        printk(<span class="string">&quot;USB Disconnected\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> USB_DC_SUSPEND:</span><br><span class="line">        printk(<span class="string">&quot;USB Suspended\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> USB_DC_RESUME:</span><br><span class="line">        printk(<span class="string">&quot;USB Resumed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 初始化复合设备 */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">composite_device_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置描述符 */</span></span><br><span class="line">    ret = usb_set_config(desc_list);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to set USB configuration\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置字符串描述符 */</span></span><br><span class="line">    ret = usb_enable_strings(string_desc);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to enable USB strings\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注册状态回调 */</span></span><br><span class="line">    ret = usb_register_status_callback(composite_status_cb);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to register USB status callback\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 使能 USB */</span></span><br><span class="line">    ret = usb_enable(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to enable USB\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-CDC-ACM-组件实现"><a href="#3-CDC-ACM-组件实现" class="headerlink" title="3. CDC-ACM 组件实现"></a>3. CDC-ACM 组件实现</h2><h3 id="3-1-CDC-ACM-接口定义"><a href="#3-1-CDC-ACM-接口定义" class="headerlink" title="3.1 CDC-ACM 接口定义"></a>3.1 CDC-ACM 接口定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_cdc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CDC-ACM 设备配置 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CDC_ACM_INTERFACE_0  0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CDC_ACM_INTERFACE_1  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CDC_ACM_ENDPOINT_IN  0x81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CDC_ACM_ENDPOINT_OUT 0x01</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_cdc_acm_config</span> <span class="title">cdc_acm_cfg</span> =</span> &#123;</span><br><span class="line">    .if0 = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_if_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_INTERFACE,</span><br><span class="line">        .bInterfaceNumber = CDC_ACM_INTERFACE_0,</span><br><span class="line">        .bAlternateSetting = <span class="number">0</span>,</span><br><span class="line">        .bNumEndpoints = <span class="number">1</span>,</span><br><span class="line">        .bInterfaceClass = USB_BCC_CDC_CONTROL,</span><br><span class="line">        .bInterfaceSubClass = ACM_SUBCLASS,</span><br><span class="line">        .bInterfaceProtocol = <span class="number">0</span>,</span><br><span class="line">        .iInterface = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/* CDC 控制描述符 */</span></span><br><span class="line">    .if0_header = &#123;</span><br><span class="line">        .bFunctionLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cdc_header_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_CS_INTERFACE,</span><br><span class="line">        .bDescriptorSubtype = HEADER_FUNC_DESC,</span><br><span class="line">        .bcdCDC = sys_cpu_to_le16(USB_1_1),</span><br><span class="line">    &#125;,</span><br><span class="line">    .if0_cm = &#123;</span><br><span class="line">        .bFunctionLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cdc_cm_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_CS_INTERFACE,</span><br><span class="line">        .bDescriptorSubtype = CALL_MANAGEMENT_FUNC_DESC,</span><br><span class="line">        .bmCapabilities = <span class="number">0x02</span>,</span><br><span class="line">        .bDataInterface = <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .if0_acm = &#123;</span><br><span class="line">        .bFunctionLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cdc_acm_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_CS_INTERFACE,</span><br><span class="line">        .bDescriptorSubtype = ACM_FUNC_DESC,</span><br><span class="line">        .bmCapabilities = <span class="number">0x02</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .if0_union = &#123;</span><br><span class="line">        .bFunctionLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cdc_union_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_CS_INTERFACE,</span><br><span class="line">        .bDescriptorSubtype = UNION_FUNC_DESC,</span><br><span class="line">        .bControlInterface = <span class="number">0</span>,</span><br><span class="line">        .bSubordinateInterface0 = <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .if0_int_ep = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_ep_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_ENDPOINT,</span><br><span class="line">        .bEndpointAddress = CDC_ACM_ENDPOINT_IN,</span><br><span class="line">        .bmAttributes = USB_DC_EP_INTERRUPT,</span><br><span class="line">        .wMaxPacketSize = sys_cpu_to_le16(<span class="number">16</span>),</span><br><span class="line">        .bInterval = <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .if1 = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_if_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_INTERFACE,</span><br><span class="line">        .bInterfaceNumber = CDC_ACM_INTERFACE_1,</span><br><span class="line">        .bAlternateSetting = <span class="number">0</span>,</span><br><span class="line">        .bNumEndpoints = <span class="number">2</span>,</span><br><span class="line">        .bInterfaceClass = USB_BCC_CDC_DATA,</span><br><span class="line">        .bInterfaceSubClass = <span class="number">0</span>,</span><br><span class="line">        .bInterfaceProtocol = <span class="number">0</span>,</span><br><span class="line">        .iInterface = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .if1_in_ep = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_ep_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_ENDPOINT,</span><br><span class="line">        .bEndpointAddress = CDC_ACM_ENDPOINT_IN,</span><br><span class="line">        .bmAttributes = USB_DC_EP_BULK,</span><br><span class="line">        .wMaxPacketSize = sys_cpu_to_le16(<span class="number">64</span>),</span><br><span class="line">        .bInterval = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .if1_out_ep = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_ep_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_ENDPOINT,</span><br><span class="line">        .bEndpointAddress = CDC_ACM_ENDPOINT_OUT,</span><br><span class="line">        .bmAttributes = USB_DC_EP_BULK,</span><br><span class="line">        .wMaxPacketSize = sys_cpu_to_le16(<span class="number">64</span>),</span><br><span class="line">        .bInterval = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-CDC-ACM-初始化和数据处理"><a href="#3-2-CDC-ACM-初始化和数据处理" class="headerlink" title="3.2 CDC-ACM 初始化和数据处理"></a>3.2 CDC-ACM 初始化和数据处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_cdc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> cdc_acm_rx_buf[<span class="number">64</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> cdc_acm_tx_buf[<span class="number">64</span>];</span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">bool</span> cdc_acm_configured;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* CDC ACM 数据接收回调 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cdc_acm_rx_cb</span><span class="params">(<span class="type">uint8_t</span> ep, <span class="type">int</span> size, <span class="type">void</span> *priv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 处理接收到的数据 */</span></span><br><span class="line">    printk(<span class="string">&quot;CDC ACM received %d bytes\n&quot;</span>, size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 回显数据 */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(cdc_acm_tx_buf, cdc_acm_rx_buf, size);</span><br><span class="line">    usb_transfer(CDC_ACM_ENDPOINT_IN, cdc_acm_tx_buf, size, USB_TRANS_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 准备接收更多数据 */</span></span><br><span class="line">    usb_transfer(CDC_ACM_ENDPOINT_OUT, cdc_acm_rx_buf, <span class="keyword">sizeof</span>(cdc_acm_rx_buf),</span><br><span class="line">                USB_TRANS_READ, cdc_acm_rx_cb, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* CDC ACM 配置回调 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cdc_acm_configure</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    cdc_acm_configured = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 启动接收 */</span></span><br><span class="line">    usb_transfer(CDC_ACM_ENDPOINT_OUT, cdc_acm_rx_buf, <span class="keyword">sizeof</span>(cdc_acm_rx_buf),</span><br><span class="line">                USB_TRANS_READ, cdc_acm_rx_cb, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* CDC ACM 回调结构体 */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_cdc_acm_ops</span> <span class="title">cdc_acm_ops</span> =</span> &#123;</span><br><span class="line">    .configured = cdc_acm_configure,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 初始化 CDC ACM */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cdc_acm_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注册 CDC ACM 设备 */</span></span><br><span class="line">    ret = usb_cdc_acm_register(&amp;cdc_acm_cfg, &amp;cdc_acm_ops);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to register CDC ACM device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-HID-组件实现"><a href="#4-HID-组件实现" class="headerlink" title="4. HID 组件实现"></a>4. HID 组件实现</h2><h3 id="4-1-HID-接口定义"><a href="#4-1-HID-接口定义" class="headerlink" title="4.1 HID 接口定义"></a>4.1 HID 接口定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_hid.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* HID 设备配置 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HID_INTERFACE      2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HID_ENDPOINT_IN    0x82</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* HID 报告描述符 - 键盘 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint8_t</span> hid_report_desc[] = &#123;</span><br><span class="line">    HID_USAGE_PAGE(HID_USAGE_GEN_DESKTOP),</span><br><span class="line">    HID_USAGE(HID_USAGE_GEN_KEYBOARD),</span><br><span class="line">    HID_COLLECTION(HID_COLLECTION_APPLICATION),</span><br><span class="line">        HID_USAGE_PAGE(HID_USAGE_KEY),</span><br><span class="line">        HID_USAGE_MIN8(<span class="number">0</span>),</span><br><span class="line">        HID_USAGE_MAX8(<span class="number">0xFF</span>),</span><br><span class="line">        HID_LOGICAL_MIN8(<span class="number">0</span>),</span><br><span class="line">        HID_LOGICAL_MAX8(<span class="number">1</span>),</span><br><span class="line">        HID_REPORT_SIZE(<span class="number">1</span>),</span><br><span class="line">        HID_REPORT_COUNT(<span class="number">8</span>),</span><br><span class="line">        HID_INPUT(<span class="number">0x02</span>),</span><br><span class="line">    HID_END_COLLECTION,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_hid_config</span> <span class="title">hid_cfg</span> =</span> &#123;</span><br><span class="line">    .interface = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_if_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_INTERFACE,</span><br><span class="line">        .bInterfaceNumber = HID_INTERFACE,</span><br><span class="line">        .bAlternateSetting = <span class="number">0</span>,</span><br><span class="line">        .bNumEndpoints = <span class="number">1</span>,</span><br><span class="line">        .bInterfaceClass = USB_BCC_HID,</span><br><span class="line">        .bInterfaceSubClass = <span class="number">0</span>,</span><br><span class="line">        .bInterfaceProtocol = <span class="number">0</span>,</span><br><span class="line">        .iInterface = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .hid_descriptor = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_hid_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_HID,</span><br><span class="line">        .bcdHID = sys_cpu_to_le16(USB_1_1),</span><br><span class="line">        .bCountryCode = <span class="number">0</span>,</span><br><span class="line">        .bNumDescriptors = <span class="number">1</span>,</span><br><span class="line">        .subdesc[<span class="number">0</span>] = &#123;</span><br><span class="line">            .bDescriptorType = USB_DESC_HID_REPORT,</span><br><span class="line">            .wDescriptorLength = sys_cpu_to_le16(<span class="keyword">sizeof</span>(hid_report_desc)),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    .ep_in = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_ep_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_ENDPOINT,</span><br><span class="line">        .bEndpointAddress = HID_ENDPOINT_IN,</span><br><span class="line">        .bmAttributes = USB_DC_EP_INTERRUPT,</span><br><span class="line">        .wMaxPacketSize = sys_cpu_to_le16(<span class="number">8</span>),</span><br><span class="line">        .bInterval = <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-HID-初始化和数据处理"><a href="#4-2-HID-初始化和数据处理" class="headerlink" title="4.2 HID 初始化和数据处理"></a>4.2 HID 初始化和数据处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_hid.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> hid_configured;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">k_work_delayable</span> <span class="title">hid_work</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* HID 中断就绪回调 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hid_int_in_ready</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;HID interrupt endpoint ready\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* HID 获取报告回调 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hid_get_report</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> usb_setup_packet *setup,</span></span><br><span class="line"><span class="params">                         <span class="type">int32_t</span> *len, <span class="type">uint8_t</span> **data)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;HID Get Report request\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* HID 设置报告回调 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hid_set_report</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> usb_setup_packet *setup,</span></span><br><span class="line"><span class="params">                         <span class="type">int32_t</span> *len, <span class="type">uint8_t</span> **data)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;HID Set Report request\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* HID 回调结构体 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">hid_ops</span> <span class="title">hid_ops</span> =</span> &#123;</span><br><span class="line">    .get_report = hid_get_report,</span><br><span class="line">    .set_report = hid_set_report,</span><br><span class="line">    .int_in_ready = hid_int_in_ready,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* HID 工作处理函数 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hid_work_handler</span><span class="params">(<span class="keyword">struct</span> k_work *work)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> report[<span class="number">8</span>];</span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> key = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 模拟按键 */</span></span><br><span class="line">    report[<span class="number">0</span>] = key++;</span><br><span class="line">    <span class="keyword">if</span> (key &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        key = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 发送报告 */</span></span><br><span class="line">    hid_int_ep_write(report, <span class="keyword">sizeof</span>(report), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 安排下一次发送 */</span></span><br><span class="line">    k_work_schedule(&amp;hid_work, K_MSEC(<span class="number">1000</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 初始化 HID */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">hid_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注册 HID 设备 */</span></span><br><span class="line">    ret = usb_hid_register_device(hid_report_desc, <span class="keyword">sizeof</span>(hid_report_desc),</span><br><span class="line">                                 &amp;hid_cfg, &amp;hid_ops);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to register HID device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化工作队列 */</span></span><br><span class="line">    k_work_init_delayable(&amp;hid_work, hid_work_handler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 启动周期性发送 */</span></span><br><span class="line">    k_work_schedule(&amp;hid_work, K_MSEC(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-MSC-组件实现"><a href="#5-MSC-组件实现" class="headerlink" title="5. MSC 组件实现"></a>5. MSC 组件实现</h2><h3 id="5-1-MSC-接口定义"><a href="#5-1-MSC-接口定义" class="headerlink" title="5.1 MSC 接口定义"></a>5.1 MSC 接口定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_msc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* MSC 设备配置 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSC_INTERFACE      3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSC_ENDPOINT_IN    0x83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSC_ENDPOINT_OUT   0x03</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_msc_config</span> <span class="title">msc_cfg</span> =</span> &#123;</span><br><span class="line">    .interface = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_if_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_INTERFACE,</span><br><span class="line">        .bInterfaceNumber = MSC_INTERFACE,</span><br><span class="line">        .bAlternateSetting = <span class="number">0</span>,</span><br><span class="line">        .bNumEndpoints = <span class="number">2</span>,</span><br><span class="line">        .bInterfaceClass = USB_BCC_MASS_STORAGE,</span><br><span class="line">        .bInterfaceSubClass = SCSI_TRANSPARENT_SUBCLASS,</span><br><span class="line">        .bInterfaceProtocol = BULK_ONLY_PROTOCOL,</span><br><span class="line">        .iInterface = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .ep_in = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_ep_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_ENDPOINT,</span><br><span class="line">        .bEndpointAddress = MSC_ENDPOINT_IN,</span><br><span class="line">        .bmAttributes = USB_DC_EP_BULK,</span><br><span class="line">        .wMaxPacketSize = sys_cpu_to_le16(<span class="number">64</span>),</span><br><span class="line">        .bInterval = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .ep_out = &#123;</span><br><span class="line">        .bLength = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> usb_ep_descriptor),</span><br><span class="line">        .bDescriptorType = USB_DESC_ENDPOINT,</span><br><span class="line">        .bEndpointAddress = MSC_ENDPOINT_OUT,</span><br><span class="line">        .bmAttributes = USB_DC_EP_BULK,</span><br><span class="line">        .wMaxPacketSize = sys_cpu_to_le16(<span class="number">64</span>),</span><br><span class="line">        .bInterval = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-MSC-初始化和数据处理"><a href="#5-2-MSC-初始化和数据处理" class="headerlink" title="5.2 MSC 初始化和数据处理"></a>5.2 MSC 初始化和数据处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/class/usb_msc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/storage/disk_access.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 存储介质配置 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISK_SECTOR_SIZE 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISK_SECTOR_COUNT 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISK_MEMORY_SIZE (DISK_SECTOR_SIZE * DISK_SECTOR_COUNT)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> disk_memory[DISK_MEMORY_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 磁盘操作回调 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">disk_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">disk_status</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> DISK_STATUS_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">disk_read</span><span class="params">(<span class="type">uint8_t</span> *data, <span class="type">uint32_t</span> sector, <span class="type">uint32_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(data, &amp;disk_memory[sector * DISK_SECTOR_SIZE],</span><br><span class="line">           count * DISK_SECTOR_SIZE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">disk_write</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">uint32_t</span> sector, <span class="type">uint32_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;disk_memory[sector * DISK_SECTOR_SIZE], data,</span><br><span class="line">           count * DISK_SECTOR_SIZE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">disk_ioctl</span><span class="params">(<span class="type">uint8_t</span> cmd, <span class="type">void</span> *buff)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> DISK_IOCTL_GET_SECTOR_COUNT:</span><br><span class="line">        *(<span class="type">uint32_t</span> *)buff = DISK_SECTOR_COUNT;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DISK_IOCTL_GET_SECTOR_SIZE:</span><br><span class="line">        *(<span class="type">uint32_t</span> *)buff = DISK_SECTOR_SIZE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 磁盘操作结构体 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">disk_operations</span> <span class="title">disk_ops</span> =</span> &#123;</span><br><span class="line">    .init = disk_init,</span><br><span class="line">    .status = disk_status,</span><br><span class="line">    .read = disk_read,</span><br><span class="line">    .write = disk_write,</span><br><span class="line">    .ioctl = disk_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 初始化 MSC */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">msc_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注册磁盘设备 */</span></span><br><span class="line">    ret = disk_access_register(<span class="string">&quot;RAM&quot;</span>, &amp;disk_ops);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to register disk\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注册 MSC 设备 */</span></span><br><span class="line">    ret = usb_msc_register(&amp;msc_cfg, <span class="string">&quot;RAM&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to register MSC device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-复合设备测试"><a href="#6-复合设备测试" class="headerlink" title="6. 复合设备测试"></a>6. 复合设备测试</h2><h3 id="6-1-主程序集成"><a href="#6-1-主程序集成" class="headerlink" title="6.1 主程序集成"></a>6.1 主程序集成</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">composite_device_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">cdc_acm_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">hid_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">msc_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;USB Composite Device Example\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化各个组件 */</span></span><br><span class="line">    cdc_acm_init();</span><br><span class="line">    hid_init();</span><br><span class="line">    msc_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化复合设备 */</span></span><br><span class="line">    composite_device_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 主循环 */</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        k_sleep(K_SECONDS(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-测试验证"><a href="#6-2-测试验证" class="headerlink" title="6.2 测试验证"></a>6.2 测试验证</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zephyr/usb/usb_device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_composite_device</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 验证设备状态 */</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">usb_dc_status_code</span> <span class="title">status</span>;</span></span><br><span class="line">    usb_dc_status(&amp;status);</span><br><span class="line">    printk(<span class="string">&quot;USB Status: %d\n&quot;</span>, status);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 验证各个组件功能 */</span></span><br><span class="line">    <span class="keyword">if</span> (status == USB_DC_CONFIGURED) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Testing CDC ACM...\n&quot;</span>);</span><br><span class="line">        <span class="comment">/* 发送测试数据 */</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *test_str = <span class="string">&quot;CDC ACM Test\r\n&quot;</span>;</span><br><span class="line">        usb_write(CDC_ACM_ENDPOINT_IN, test_str, <span class="built_in">strlen</span>(test_str), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        printk(<span class="string">&quot;Testing HID...\n&quot;</span>);</span><br><span class="line">        <span class="comment">/* 发送按键报告 */</span></span><br><span class="line">        <span class="type">uint8_t</span> report[<span class="number">8</span>] = &#123;<span class="number">0x04</span>&#125;; <span class="comment">/* &#x27;a&#x27; 键 */</span></span><br><span class="line">        hid_int_ep_write(report, <span class="keyword">sizeof</span>(report), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        printk(<span class="string">&quot;MSC should be accessible as a disk drive\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-最佳实践"><a href="#7-最佳实践" class="headerlink" title="7. 最佳实践"></a>7. 最佳实践</h2><ol>
<li><p>接口编号分配：</p>
<ul>
<li>确保每个接口使用唯一的接口编号</li>
<li>考虑使用 IAD (Interface Association Descriptor) 将相关接口组合在一起</li>
</ul>
</li>
<li><p>端点分配：</p>
<ul>
<li>合理分配端点资源，避免冲突</li>
<li>考虑不同设备类的端点需求和优先级</li>
</ul>
</li>
<li><p>描述符设计：</p>
<ul>
<li>确保描述符结构正确且完整</li>
<li>提供清晰的设备和接口标识信息</li>
</ul>
</li>
<li><p>资源管理：</p>
<ul>
<li>合理分配内存和缓冲区</li>
<li>考虑多个设备类之间的资源共享</li>
</ul>
</li>
<li><p>错误处理：</p>
<ul>
<li>实现完整的错误检查和恢复机制</li>
<li>考虑一个组件失败对整个设备的影响</li>
</ul>
</li>
<li><p>电源管理：</p>
<ul>
<li>实现正确的挂起&#x2F;恢复处理</li>
<li>考虑不同组件的电源需求</li>
</ul>
</li>
<li><p>测试验证：</p>
<ul>
<li>在不同主机系统上测试</li>
<li>验证各个组件的功能和互操作性</li>
</ul>
</li>
<li><p>兼容性：</p>
<ul>
<li>遵循 USB 规范和各设备类规范</li>
<li>考虑向后兼容性和不同主机系统的支持</li>
</ul>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io">JoeNero</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://joeforkyou.github.io/2025/03/21/nodic/zephyr/usb/composite_device/">https://joeforkyou.github.io/2025/03/21/nodic/zephyr/usb/composite_device/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/%E7%BE%8E%E5%A5%B3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/21/nodic/zephyr/usb/basic_device/" title="basic_device"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">basic_device</div></div><div class="info-2"><div class="info-item-1">Zephyr USB 基础设备类指南1. USB 基础配置1.1 通用配置 (prj.conf)123456789101112131415# USB 设备栈支持CONFIG_USB_DEVICE_STACK=yCONFIG_USB_DEVICE_MANUFACTURER=&quot;Zephyr&quot;CONFIG_USB_DEVICE_PRODUCT=&quot;USB Device&quot;CONFIG_USB_DEVICE_VID=0x2FE3CONFIG_USB_DEVICE_PID=0x0100CONFIG_USB_DEVICE_SN=&quot;0123456789AB&quot;# USB 设备日志CONFIG_USB_DRIVER_LOG_LEVEL_ERR=yCONFIG_USB_DEVICE_LOG_LEVEL_ERR=y# USB 缓冲区配置CONFIG_USB_REQUEST_BUFFER_SIZE=128CONFIG_USB_MAX_NUM_ENDPOINTS=8  1.2...</div></div></div></a><a class="pagination-related" href="/2025/03/21/nodic/zephyr/toolchain/build_system/" title="build_system"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">build_system</div></div><div class="info-2"><div class="info-item-1">Zephyr 构建系统本文档详细介绍了 Zephyr RTOS 的构建系统，包括 CMake 构建流程、West 命令工具、构建配置选项以及自定义构建方法。 CMake 构建流程Zephyr 使用 CMake 作为其主要构建系统，结合 Ninja 或 Make 作为构建工具。 构建系统架构Zephyr 的构建系统由以下几个主要部分组成：  CMake 脚本：定义构建逻辑和目标 Kconfig 系统：管理配置选项 设备树：描述硬件配置 West：元构建工具，简化命令行操作  基本构建流程Zephyr 应用程序的构建流程如下：  配置阶段  处理 Kconfig 选项 解析设备树源文件 生成构建系统缓存   生成阶段  生成构建规则 创建构建目标   构建阶段  编译源代码 链接目标文件 生成最终二进制文件    CMake 脚本结构Zephyr 项目的 CMake 脚本组织结构：  zephyr&#x2F;CMakeLists.txt：主 CMake...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E7%BE%8E%E5%A5%B3.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">JoeNero</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">127</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/JoeForkYou"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/JoeForkYou" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:17549663745@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">wow!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zephyr-USB-%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">Zephyr USB 复合设备指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87%E5%9F%BA%E7%A1%80"><span class="toc-number">1.1.</span> <span class="toc-text">1. 复合设备基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87%E9%85%8D%E7%BD%AE-prj-conf"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 复合设备配置 (prj.conf)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 复合设备描述符结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">2. 复合设备实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E8%AE%BE%E5%A4%87%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%AE%9A%E4%B9%89"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 设备描述符定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 复合设备初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-CDC-ACM-%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">3. CDC-ACM 组件实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-CDC-ACM-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 CDC-ACM 接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-CDC-ACM-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 CDC-ACM 初始化和数据处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-HID-%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">4. HID 组件实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-HID-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 HID 接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-HID-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 HID 初始化和数据处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-MSC-%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.</span> <span class="toc-text">5. MSC 组件实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-MSC-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 MSC 接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-MSC-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 MSC 初始化和数据处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.</span> <span class="toc-text">6. 复合设备测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E4%B8%BB%E7%A8%8B%E5%BA%8F%E9%9B%86%E6%88%90"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 主程序集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 测试验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.7.</span> <span class="toc-text">7. 最佳实践</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/04/CPP/CPP%E5%9F%BA%E7%A1%80_5_%E9%80%9F%E9%80%9A/" title="【CPP基础】【五】【CPP速通】">【CPP基础】【五】【CPP速通】</a><time datetime="2025-04-04T08:51:04.000Z" title="Created 2025-04-04 16:51:04">2025-04-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/development/debugging/" title="debugging">debugging</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/development/devicetree/" title="devicetree">devicetree</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/development/driver/" title="driver">driver</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/21/nodic/zephyr/development/drivers/" title="drivers">drivers</a><time datetime="2025-03-21T12:49:56.000Z" title="Created 2025-03-21 20:49:56">2025-03-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By JoeNero</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true});</script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>